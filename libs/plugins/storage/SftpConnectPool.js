"use strict";var t=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function o(t){try{c(i.next(t))}catch(t){r(t)}}function h(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,h)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SftpPoolFactory=exports.SftpConnectPool=exports.PoolObj=void 0;const n=require("../../packages/log"),i=e(require("ssh2-sftp-client")),s=require("../../utils/CryptoUtil"),r=require("../../utils/RandomUtil"),o=require("node-schedule");var h;!function(t){t.READ="read",t.WRITE="write",t.BOTH="both"}(h||(h={}));class c{constructor(t){this.isDisable=!1,this.sftpConn=t,this.lastRunTime=Date.now(),this.running=0,this.id=r.RandomUtil.generateUUID()}getId(){return this.id}getSftpConn(){return this.sftpConn}getIsDisable(){return this.isDisable||void 0===this.sftpConn.sftp}getRunning(){return this.running}runningAddOne(){++this.running}runningReduceOne(){--this.running}getLastRunTime(){return this.lastRunTime}setLastRunTime(){this.lastRunTime=Date.now()}close(){return t(this,void 0,void 0,(function*(){try{this.isDisable=!0,yield this.sftpConn.end()}catch(t){throw n.OhpmLazyLogger.error(`"sftp" is configured wrong, ${t.message}.`),new Error('"sftp" close wrong')}}))}}exports.PoolObj=c;class u{constructor(t){this.started=!1,this.sftpReadArr=[],this.sftpWriteArr=[],this.createNewSftpConnecting=!1,this.conf=t,this.name=t.name}init(){return t(this,void 0,void 0,(function*(){if(yield this.listenSftpService(),!1===this.started){this.started=!0;for(let t=0;t<1;t++)yield this.createNewConn(h.BOTH);yield this.scheduleCheckConn()}}))}assign(e){return t(this,void 0,void 0,(function*(){if(!this.sftpConnStatus)return null;const t=Date.now(),n=e===h.READ?this.sftpReadArr:this.sftpWriteArr;for(;;){for(let t=0;t<n.length;t++)if(!n[t].getIsDisable()&&n[t].getRunning()<5)return n[t].runningAddOne(),n[t];if(n.length<20&&!this.createNewSftpConnecting&&(this.createNewSftpConnecting=!0,yield this.createNewConn(e),this.createNewSftpConnecting=!1),yield this.sleep(300),Date.now()-t>4e4)throw new Error("connect timeout")}}))}scheduleCheckConn(){return t(this,void 0,void 0,(function*(){(0,o.scheduleJob)("checkConnect","1,10,20,30,40,50 * * * * *",(()=>t(this,void 0,void 0,(function*(){if(!this.sftpConnStatus){if(!(yield this.listenSftpService()))return}yield this.closeIdleConn(h.READ),yield this.closeIdleConn(h.WRITE),yield this.checkMinConn(h.READ),yield this.checkMinConn(h.WRITE)}))))}))}closeIdleConn(e){return t(this,void 0,void 0,(function*(){const t=e===h.READ?this.sftpReadArr:this.sftpWriteArr;if(1===t.length)return;const n=[];for(let e=0;e<t.length-1;e++)0===t[e].getRunning()&&Date.now()-t[e].getLastRunTime()>3e4&&(yield t[e].close(),n.push(e));for(let e=0;e<n.length;e++)t.splice(n[e]-e,1)}))}checkMinConn(e){return t(this,void 0,void 0,(function*(){const t=e===h.READ?this.sftpReadArr:this.sftpWriteArr;if(t.length<1)for(let n=0;n<1-t.length;n++)yield this.createNewConn(e)}))}sleep(e){return t(this,void 0,void 0,(function*(){return new Promise((t=>setTimeout(t,e)))}))}release(e,n){return t(this,void 0,void 0,(function*(){if(!this.sftpConnStatus)return;const t=n===h.READ?this.sftpReadArr:this.sftpWriteArr;for(let n=0;n<t.length;n++)if(t[n].getId()===e){t[n].setLastRunTime(),t[n].runningReduceOne();break}}))}createNewConn(e){return t(this,void 0,void 0,(function*(){if(e===h.READ&&20===this.sftpReadArr.length)return;if(e===h.WRITE&&20===this.sftpWriteArr.length)return;const n=()=>t(this,void 0,void 0,(function*(){const t=yield this.create(e),n=new c(t);this.sftpReadArr.push(n)})),i=()=>t(this,void 0,void 0,(function*(){const t=yield this.create(e),n=new c(t);this.sftpWriteArr.push(n)}));e===h.BOTH&&(yield n(),yield i()),e===h.READ&&(yield n()),e===h.WRITE&&(yield i())}))}create(e){return t(this,void 0,void 0,(function*(){let t=new i.default(this.conf.name);const r=e===h.READ?this.conf.read_username:this.conf.write_username,o=e===h.READ?this.conf.read_password:this.conf.write_password,c=s.CryptoUtil.getVersion(),u=yield s.CryptoUtil.decrypt(o,c);return yield t.connect({host:this.conf.host,port:this.conf.port,username:r,password:u}).catch((e=>{throw t=null,n.OhpmLazyLogger.error(`"sftp" is configured wrong, name is "${this.conf.name}" config incorrect, ${e.message}.`),new Error('"sftp" is configured wrong')})),t}))}listenSftpService(){return t(this,void 0,void 0,(function*(){try{const e=yield this.create(h.READ);return!!e&&(this.sftpConnStatus=e,this.sftpConnStatus.once("close",(()=>t(this,void 0,void 0,(function*(){n.OhpmLazyLogger.error(`the sftp service named "${this.conf.name}" is interrupted.`),this.sftpConnStatus=null,this.sftpReadArr=[],this.sftpWriteArr=[]})))),!0)}catch(t){return!1}}))}isAvailable(){return!!this.sftpConnStatus}}exports.SftpConnectPool=u;exports.SftpPoolFactory=class{static getSftpPool(e){return t(this,void 0,void 0,(function*(){const t=new u(e);return yield t.init(),t}))}};