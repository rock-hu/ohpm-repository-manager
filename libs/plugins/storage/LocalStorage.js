"use strict";var e=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}l((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStorage=void 0;const i=t(require("path")),r=require("../../utils/FsUtil"),o=require("../../packages/log"),s=require("../../packages/config/config"),a=require("../../common/Constants"),n=require("../../utils/CommonUtil");exports.LocalStorage=class{init(){return e(this,void 0,void 0,(function*(){let e=s.config.store.config.path;if(!e)throw new Error('config "store.config.path" is empty');if(e=decodeURIComponent(e),e.includes(".."))throw new Error('"store.config.path" is configured wrong: The relative path cannot contain ../ ');this.baseDir=i.default.resolve(a.Constants.DATA_DIR,e),this.server=n.CommonUtil.getServerAddress();try{yield r.FsUtil.createDirIfNotExists(this.baseDir),yield r.FsUtil.chmod(this.baseDir,488)}catch(e){throw o.OhpmLazyLogger.error(`"store.config.path" is configured wrong, please set the parameters correctly. error: ${e}`),new Error('"store.config.path" is configured wrong')}}))}delete(t){return e(this,void 0,void 0,(function*(){if(!t)return o.OhpmLazyLogger.warn("localStorage: file id is not defined."),!1;if(decodeURIComponent(t).includes(".."))return o.OhpmLazyLogger.warn('localStorage: delete id includes ".."!'),!1;const e=i.default.join(this.baseDir,t);return(yield r.FsUtil.exists(e))?(yield r.FsUtil.rm(e,{recursive:!0,force:!0}),yield this.deleteRedundantDirs(i.default.dirname(e)),o.OhpmLazyLogger.info("localStorage: file delete success! id: ",t),!0):(o.OhpmLazyLogger.warn("localStorage: file does not exist! id: ",t),!1)}))}deleteRedundantDirs(t){return e(this,void 0,void 0,(function*(){if(t===this.baseDir)return;if((yield r.FsUtil.stat(t)).isDirectory()){0===(yield r.FsUtil.readdir(t)).length&&(yield r.FsUtil.rm(t,{recursive:!0,force:!0}),yield this.deleteRedundantDirs(i.default.dirname(t)))}}))}download(t){return e(this,void 0,void 0,(function*(){const e=i.default.join(this.baseDir,t);return r.FsUtil.readFile(e)}))}downloadStream(t){return e(this,void 0,void 0,(function*(){const e=i.default.join(this.baseDir,t),o=r.FsUtil.createReadStream(e),s=e=>{throw o.destroy(e),o.removeListener("error",s),e};return o.once("error",s),o}))}save(t,s){return e(this,void 0,void 0,(function*(){if(!t)throw o.OhpmLazyLogger.warn("localStorage: srcPath does not exist."),Error("srcPath does not exist! ");if(!(yield r.FsUtil.exists(t)))throw o.OhpmLazyLogger.info("localStorage: srcPath does not exist. packageName: ",s.packageName),Error("srcFile does not exist");const e=i.default.basename(t);let n;if(s.isPackage)n=i.default.posix.join(s.repoName,s.packageName);else{let e;e=s.packageName.startsWith("@")?s.packageName.split("/")[1]:s.packageName,n=i.default.posix.join(s.repoName,s.packageName,`${e}-${s.version}`)}yield r.FsUtil.createDirIfNotExists(i.default.join(this.baseDir,n));const l=i.default.join(this.baseDir,n,e);yield r.FsUtil.copyFile(t,l),yield r.FsUtil.chmod(l,a.Constants.PERMISSIONS600);const d=i.default.posix.join(n,e);return o.OhpmLazyLogger.info(`save file successfully, fileId: ${d}.`),d}))}};