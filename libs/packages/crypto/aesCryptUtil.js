"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,r,c){void 0===c&&(c=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,c,n)}:function(e,t,r,c){void 0===c&&(c=r),e[c]=t[r]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var c={};if(null!=r)for(var n in r)"default"!==n&&Object.prototype.hasOwnProperty.call(r,n)&&e(c,r,n);return t(c,r),c};Object.defineProperty(exports,"__esModule",{value:!0}),exports.simpleDecryptAes=exports.simpleEncryptAes=exports.decryptAesGcm=exports.encryptAesGcm=void 0;const c=require("./commCryptUtil"),n=require("./constants"),i=r(require("node:crypto")),s=require("./CommonUtil");function u(e,t,r){let u=null;if(!((0,s.isValidStr)(e)&&(0,s.isValidArr)(Array.from(t))))return u;const o=(0,c.byte2HexStr)(t),a=(0,c.stripCryptHead)(e);let l;if(l=null===a?e:a,!l)return u;if(l.indexOf(":")<2*n.KEY_96BIT_SIZE)return u;const f=l.split(":");if(2!==f.length)return u;const p=f[0],d=f[1];switch(r){case"cbc":u=function(e,t,r){const c=Buffer.from(t,"hex"),n=Buffer.from(r,"hex"),s=i.createDecipheriv("aes-256-cbc",c,n);let u=s.update(e,"base64","utf8");return u+=s.final("utf8"),u}(d,o,p);break;case"gcm":u=function(e,t,r){const s=Buffer.from(e,"hex"),u=s.subarray(-16),o=s.subarray(0,s.length-16),a=(0,c.hexStr2Byte)(r),l=i.createDecipheriv("aes-128-gcm",t,a);l.setAuthTag(u);const f=l.update(o),p=l.final();return n.DEFAULT_DECODER.decode(Buffer.concat([f,p]))}(d,t,p)}return u}function o(e,t,r){let u=null,o=null;if((0,s.isValidStr)(e)&&(0,c.isKeyLengthValid)(t))switch(r){case"cbc":o=function(e,t,r=n.KEY_128BIT_SIZE){const s=(0,c.genSecureRandomByte)(r),u=(0,c.byte2HexStr)(s),o=Buffer.from(t,"hex"),a=i.createCipheriv("aes-256-cbc",o,s);let l=a.update(e,"utf8","base64");return l+=a.final("base64"),{head:n.KEY_HEAD,iv:u,encText:l}}(e,t);break;case"gcm":o=function(e,t){const r=(0,c.genSecureRandomByte)(n.KEY_96BIT_SIZE),s=(0,c.hexStr2Byte)(t),u=i.createCipheriv("aes-128-gcm",s,r),o=u.update(e,"utf8"),a=u.final(),l=u.getAuthTag(),f=Buffer.concat([o,a,l]);return{head:n.KEY_HEAD,iv:(0,c.byte2HexStr)(r),encText:f.toString("hex")}}(e,t)}var a;return o&&(u=`${(a=o).head}${a.iv}:${a.encText}`),u}exports.encryptAesGcm=function(e,t,r){return function(e,t,r,c){let n=null;if((0,s.isValidStr)(e)&&(0,s.isValidStr)(t)&&(0,s.isValidStr)(r.getRootKeyHex())){const i=r.getRootKey();let s=null;if(i&&(s=u(t,i,"cbc")),s)switch(c){case"cbc":n=o(e,s,"cbc");break;case"gcm":n=o(e,s,"gcm")}}return n}(e,t,r,"gcm")},exports.decryptAesGcm=function(e,t,r){return function(e,t,r,n){let i=null;if((0,s.isValidStr)(e)&&(0,s.isValidStr)(t)&&(0,s.isValidStr)(r.getRootKeyHex())){const s=r.getRootKey();let o=null,a=null;if(s&&(o=u(t,s,"cbc")),o&&(a=(0,c.hexStr2Byte)(o)),a)switch(n){case"cbc":i=u(e,a,"cbc");break;case"gcm":i=u(e,a,"gcm")}}return i}(e,t,r,"gcm")},exports.simpleEncryptAes=o,exports.simpleDecryptAes=function(e,t,r){let n=null;const i=(0,s.isValidStr)(e)&&(0,c.isValidHexStrKey)(t),o=(0,c.hexStr2Byte)(t);return i&&o&&("cbc"===r?n=u(e,o,"cbc"):"gcm"===r&&(n=u(e,o,"gcm"))),n};