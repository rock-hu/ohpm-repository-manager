"use strict";var e=this&&this.__awaiter||function(e,r,i,t){return new(i||(i=Promise))((function(o,n){function s(e){try{l(t.next(e))}catch(e){n(e)}}function a(e){try{l(t.throw(e))}catch(e){n(e)}}function l(e){var r;e.done?o(e.value):(r=e.value,r instanceof i?r:new i((function(e){e(r)}))).then(s,a)}l((t=t.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.batchDownloadExecute=void 0;const i=require("../../../common/checkPkgInfoJson"),t=require("../../../exportPkgInfoCmd"),o=require("../../../../../common/init"),n=require("../../../../../packages/log"),s=require("../../../../../service/client/publish/PublishService"),a=require("../../../../../common/DbFactory"),l=require("../../../common/getManifestDbFilter"),u=require("../../../../../utils/FsUtil"),c=r(require("path")),d=require("../../../../../packages/config/config"),f=require("../../../common/checkAuthPluginUserId"),p=r(require("compressing")),g=require("../../batchDownloadCmd"),m=require("../../../common/genErrorTxt"),h=require("../../../../../service/localStorage/DownloadMeta"),y=require("../../../../../utils/CommonUtil"),v=require("../../../../../service/localStorage/StorageService"),F=require("../../../../../plugins/auth/CustomAuth"),L=require("../../../../../service/group/GroupMemberRepository"),w=require("../../../../../packages/definitions/types"),U=require("../../../../../service/group/GroupService"),x=require("../../../../../service/user/UserRepository");function $(r,i,t,o,s){return e(this,void 0,void 0,(function*(){const l=t,u=l[0].groupName||l[0].group||"",c={packageFile:s,packageName:o,user:"",userId:"",group:u,distTags:[]},p=yield a.commonDB.findByFilter(g.USER_TABLE,{filter:{id:l[0].authorId}});return p.recordList&&!p.recordList.length?d.config.auth_plugin&&(yield(0,f.checkAuthPluginUserId)(l[0].authorId))?(c.user=yield F.CustomAuth.getInstance().getUserInfo(l[0].authorId),c.userId=l[0].authorId):c.user=yield function(r,i){return e(this,void 0,void 0,(function*(){if(i){if(!(yield U.groupService.exists(i)))throw new Error(`Failed to specify the actual user for "${r}" package, "${i}" group does not exist.`);const e=(yield L.groupMemberRepository.findByFilter({group_name:i,role:w.RoleType.Admin})).recordList[0],t=yield x.userRepository.findUserByName(e.member_name);if(t.recordList.length)return n.OhpmLazyLogger.warn(`the publish user of the "${r}" does not exist, specify "${t.recordList[0].name}" as the new publish user.`),t.recordList[0].name;throw new Error(`Failed to specify the actual user for "${r}" package, the "${i}" group exists, but the "${e.member_name}" owner of the group does not exist.`)}{const e=yield a.commonDB.findByFilter(g.USER_TABLE,{filter:{role:g.AdminRole}});if(!e.recordList.length)throw new Error(`Failed to specify the actual user for "${r}" package, no administrator is found.`);return n.OhpmLazyLogger.warn(`the publish user of the "${r}" does not exist, specify "${e.recordList[0].name}" as the new publish user.`),e.recordList[0].name}}))}(o,u):c.user=p.recordList[0].name,yield function(r,i,t){return e(this,void 0,void 0,(function*(){const e=yield a.commonDB.findByFilter("dist_tags",{filter:{packageName:r,version:i}});if(e.recordList&&e.recordList.length)for(let r=0;r<e.recordList.length;r++){const{tag:i}=e.recordList[r];t.distTags.push(i)}}))}(r,i,c),c}))}function k(r){return e(this,void 0,void 0,(function*(){const{repoName:i,name:t,fileName:o,group:n}=yield function(r){return e(this,void 0,void 0,(function*(){const e={repoName:r.repoName,name:r.name,fileName:r.fileName,group:r.groupName?`@${r.groupName}`:r.group?`@${r.group}`:""};return(r.groupName||r.group)&&(e.name=r.name.split("/")[1],e.fileName=r.fileName.split("/")[1]),e}))}(r),s=new h.DownloadMeta(i,t,o,null,n);let a;a=n?`/${i}/${n}/${t}/-/${n}/${o}`:`/${i}/${t}/-/${o}`;const l=yield b(a,s,o);if(r.hspFileId){const e=a.replace(".har",".hsp"),r=new h.DownloadMeta(i,t,o.replace(".har",".hsp"),null,n),s=yield b(e,r,o.replace(".har",".hsp")),d=y.CommonUtil.genRandomTempDir(),f=c.default.join(d,o.replace(".har",""));yield u.FsUtil.createDirIfNotExists(f);const g=c.default.join(d,o.replace(".har",".tgz"));return yield u.FsUtil.copyFile(s,c.default.join(f,c.default.basename(s))),yield u.FsUtil.copyFile(l,c.default.join(f,c.default.basename(l))),yield p.default.tgz.compressDir(f,g),yield u.FsUtil.rm(f,{recursive:!0,force:!0}),(yield u.FsUtil.exists(l))&&(yield u.FsUtil.rm(c.default.dirname(l),{recursive:!0,force:!0})),(yield u.FsUtil.exists(s))&&(yield u.FsUtil.rm(c.default.dirname(s),{recursive:!0,force:!0})),g}const d=y.CommonUtil.genRandomTempDir();yield u.FsUtil.createDirIfNotExists(d);const f=c.default.join(d,c.default.basename(l));return yield u.FsUtil.copyFile(l,f),(yield u.FsUtil.exists(l))&&(yield u.FsUtil.rm(c.default.dirname(l),{recursive:!0,force:!0})),f}))}function b(r,i,t){return e(this,void 0,void 0,(function*(){const e=yield v.StorageService.getDownloadFileBuffer(r,i),o=y.CommonUtil.genRandomTempDir();yield u.FsUtil.createDirIfNotExists(o);const n=c.default.posix.join(o,t);return yield u.FsUtil.writeFile(n,e),n}))}exports.batchDownloadExecute=function(r,d,f){return e(this,void 0,void 0,(function*(){const h=yield(0,i.checkPkgInfoJson)(r);yield(0,t.loadConfig)("batch download"),yield o.MainInit.particalInit();const y=[],v={packageArray:[]};for(let e=0;e<h.length;e++){n.OhpmLazyLogger.info(`download "${h[e]}".`);const r=h[e].slice(0,h[e].lastIndexOf("@")),i=(0,s.getVerifyName)(r),t=h[e].slice(h[e].lastIndexOf("@")+1),{recordList:o}=yield a.commonDB.findByFilter(g.PACKAGE_MANIFEST_TABLE,{filter:(0,l.getManifestDbFilter)(i,t)});if(!o||!o.length){const r=`fail to download "${h[e]}", not found in the database.`;n.OhpmLazyLogger.error(r),y.push(r);continue}let f;try{let i;f=yield k(o[0]),i=f.endsWith(".har")?`${h[e].replace("/","+")}.har`:`${h[e].replace("/","+")}.tgz`;const n=yield $(r,t,o,h[e],i);v.packageArray.push(n),yield u.FsUtil.rename(f,c.default.join(d,i))}catch(e){n.OhpmLazyLogger.error(e.message),y.push(e.message)}finally{(yield u.FsUtil.exists(c.default.dirname(f)))&&(yield u.FsUtil.rm(c.default.dirname(f),{recursive:!0,force:!0}))}}yield u.FsUtil.writeFile(c.default.join(d,g.PkgInfoJson),JSON.stringify(v,null,2));const F=c.default.join(process.cwd(),f);v.packageArray.length&&(yield p.default.zip.compressDir(d,F)),yield function(r,i,t,o){return e(this,void 0,void 0,(function*(){if(r.length){if(r.length===i)return n.OhpmLazyLogger.info("no package is successfully downloaded."),void(yield(0,m.genErrorTxt)(r));n.OhpmLazyLogger.info(`${i} package(s) download successfully.`),n.OhpmLazyLogger.error(t-i+" package(s) download unsuccessfully."),yield(0,m.genErrorTxt)(r)}else n.OhpmLazyLogger.info(`all ${i} package(s) are successfully download.`);i&&n.OhpmLazyLogger.info(`save the .zip file to : "${c.default.normalize(o)}".`)}))}(y,v.packageArray.length,h.length,F)}))};