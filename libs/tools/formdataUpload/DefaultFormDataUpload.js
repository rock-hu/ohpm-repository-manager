"use strict";var e=this&&this.__awaiter||function(e,o,i,t){return new(i||(i=Promise))((function(r,n){function a(e){try{l(t.next(e))}catch(e){n(e)}}function s(e){try{l(t.throw(e))}catch(e){n(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof i?o:new i((function(e){e(o)}))).then(a,s)}l((t=t.apply(e,o||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DefaultFormDataUpload=void 0;const i=o(require("path")),t=require("crypto"),r=require("../../common/RepoError"),n=require("../../utils/FsUtil"),a=require("../../common"),s=require("../../common/ErrorCode"),l=o(require("fs")),d=require("../../packages/log"),u=require("../../utils/CommonUtil"),p=require("./busboy"),f=require("../../packages/config/config");exports.DefaultFormDataUpload=class{constructor(e){this.options=e}single(o){return(i,t,n)=>e(this,void 0,void 0,(function*(){var e;i.body||(i.body={}),f.config.allow_new_file_upload_api?yield this.handleFormDataByBusboy(i,o,n):("multipart/form-data"!==(null===(e=i.headers["content-type"])||void 0===e?void 0:e.split("; ")[0])&&n(new r.RepoServerError(a.ErrorCode.OnlySupportDest,s.MESSAGE_CN[a.ErrorCode.OnlySupportDest])),yield this.handleRequestFormData(i,o,n))}))}handleFormDataByBusboy(o,i,t){return e(this,void 0,void 0,(function*(){const e=(0,p.busboy)({headers:o.headers});e.on("file",((e,i,n)=>{if(!n.filename)return i.resume(),void t(new r.RepoClientError(a.ErrorCode.NotFoundUploadFile,"Not found upload file!"));this.saveFileToDisk(e,i,n,o,t)})),e.on("field",((e,i,n)=>{e?n.nameTruncated?t(new r.RepoClientError(a.ErrorCode.LimitFieldKey,"Field name too long!")):n.valueTruncated?t(new r.RepoClientError(a.ErrorCode.LimitFieldValue,"Field value too long!")):(o.body[e]=i,d.OhpmLazyLogger.debug(`formDataUpload.single.handleFormDataByBusboy, \n          found field: ${e}, value: ${JSON.stringify(i)}, extra: ${JSON.stringify(n)}.`)):t(new r.RepoClientError(a.ErrorCode.MissingFieldName,"Field name missing!"))})),e.on("error",(e=>{t(e)})),o.pipe(e)}))}saveFileToDisk(o,r,a,s,p){d.OhpmLazyLogger.debug(`saveFileToDisk, start save file: ${a.filename}, extra: ${JSON.stringify(a)}`);const f=i.default.join(this.options.dest,(0,t.randomUUID)().toString()),m=l.default.createWriteStream(f);m.once("close",(()=>e(this,void 0,void 0,(function*(){d.OhpmLazyLogger.debug(`saveFileToDisk, save file succeed, fieldName: ${o}, originalFile: ${a.filename}`),p()})))).on("finish",(()=>{m.end(),s[o]={mimetype:a.mimeType,path:f,size:m.bytesWritten,fileName:a.filename,originalname:a.filename},d.OhpmLazyLogger.debug(`saveFileToDisk, write stream finished, fileSize: ${m.bytesWritten}`)})).on("error",(o=>e(this,void 0,void 0,(function*(){m.end(),(yield n.FsUtil.exists(f))&&(yield u.CommonUtil.fsrm(f)),p(o)})))),r.pipe(m)}handleRequestFormData(o,r,a){return e(this,void 0,void 0,(function*(){d.OhpmLazyLogger.debug(`handleRequestFormData, fieldName: ${r}`);const s=i.default.join(this.options.dest,(0,t.randomUUID)().toString()),u=`--${o.headers["content-type"].split("boundary=")[1]}`;yield n.FsUtil.createDirIfNotExists(i.default.join(this.options.dest));const p=i.default.join(this.options.dest,(0,t.randomUUID)().toString()),f=l.default.createWriteStream(p,{flags:"a"});f.once("close",(()=>e(this,void 0,void 0,(function*(){d.OhpmLazyLogger.debug("handleRequestFormData, close");try{const e=yield n.FsUtil.readFile(p);o[r]=yield this.parseFile(o,e,u,s),yield this.removeCacheFile(p),a()}catch(e){d.OhpmLazyLogger.warn(`handleRequestFormData fail: ${e.message}`,e),yield this.removeCacheFile(p,s),a(e)}})))),o.on("data",(o=>{d.OhpmLazyLogger.debug("handleRequestFormData, data"),f.write(o,(o=>e(this,void 0,void 0,(function*(){o&&(d.OhpmLazyLogger.warn(`handleRequestFormData fail: ${o.message}`,o),f.close(),yield this.removeCacheFile(p,s),a(o))}))))})),o.once("end",(()=>e(this,void 0,void 0,(function*(){d.OhpmLazyLogger.debug("handleRequestFormData, end"),f.close()}))))}))}removeCacheFile(...o){return e(this,void 0,void 0,(function*(){if(o&&o.length)for(const e of o)(yield n.FsUtil.exists(e))&&(yield u.CommonUtil.fsrm(e))}))}parseFile(o,i,t,l){return e(this,void 0,void 0,(function*(){const e=this.split(i,t).slice(1,-1);let d;for(const i of e){const[e,t]=this.split(i,"\r\n\r\n"),u=this.split(e,"\r\n").slice(1),p=this.parseHeader(u[0].toString());if(p.filename){if(d)throw new r.RepoServerError(a.ErrorCode.OnlySupportSingleFileUpload,s.MESSAGE_CN[a.ErrorCode.OnlySupportSingleFileUpload]);const e=this.getContentType(u);d={originalname:p.filename,mimetype:e,size:t.subarray(0,-2).length,path:l},yield n.FsUtil.writeFile(l,t.subarray(0,-2))}else o.body[p.name]=t.subarray(0,-2).toString()}if(!d)throw new r.RepoServerError(a.ErrorCode.NotFoundUploadFile,s.MESSAGE_CN[a.ErrorCode.NotFoundUploadFile]);return d}))}getContentType(e){for(const o of e){const[e,i]=o.toString().split(": ");if("Content-Type"===e)return i}return""}parseHeader(e){const[o,i]=e.split(": "),t={};return i.split("; ").forEach((e=>{const[o,i=""]=e.split("=");t[o]=i&&JSON.parse(i)})),t}split(e,o){const i=[];let t=0,r=e.indexOf(o,0);for(;-1!==r;)i.push(e.subarray(t,r)),t=r+o.length,r=e.indexOf(o,r+o.length);return i.push(e.subarray(t)),i}};