"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,n)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var i={};if(null!=o)for(var n in o)"default"!==n&&Object.prototype.hasOwnProperty.call(o,n)&&e(i,o,n);return t(i,o),i},i=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function l(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,l)}a((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.deployExecute=exports.deployCmd=void 0;const r=n(require("fs")),s=n(require("path")),l=o(require("js-yaml")),a=require("../common/Constants"),d=require("../common/init"),u=require("../packages/config/config"),c=require("../packages/log"),f=require("../utils/CommonUtil"),p=require("../utils/FsUtil"),y=require("../utils/PackUtil"),h=require("./restore"),m=require("./install"),v=require("../packages/config/constants"),_=require("../common/DbAndStoreType"),g=n(require("log4js")),C=require("../common/CommandsUtil"),w=require("../packages/config/checker"),O=n(require("semver")),b=require("../common/FSFactory");function E(e,t){return i(this,void 0,void 0,(function*(){(0,m.checkNonRootPermission)("deploy");const o=yield(0,m.readCongFileFromEnv)(),n=s.default.join(a.Constants.WORK_DIR,v.PathConstants.RUNTIME_PATH);if((yield p.FsUtil.exists(o))&&(yield p.FsUtil.exists(n)))throw new Error("already installed or deployed before");t.deploy_root?yield F(e,t):yield(0,C.confirmSubmit)(`parameter 'deploy_root' is not specified, the default path 'deploy_root = ${a.Constants.DATA_DIR}' will be used, please confirm whether to continue the deployment, continue? (Y/N)`,function(e,t){return()=>i(this,void 0,void 0,(function*(){try{yield F(e,t)}catch(e){(0,c.consoleError)(`server fail to deploy: ${e}.`),g.default.shutdown((()=>process.exit(1)))}}))}(e,t))}))}function F(e,t){var o,n;return i(this,void 0,void 0,(function*(){let{deploy_root:m,logs:g,uplinkCachePath:C}=t;m=m||a.Constants.DATA_DIR;const E=s.default.resolve(process.cwd(),m),F=s.default.join(E,v.PathConstants.TEMP_CONFIG_PATH);let D;yield(0,h.checkPackedFile)(e),yield function(e){return i(this,void 0,void 0,(function*(){const{DATA_DIR:t}=a.Constants;e!==t||(yield p.FsUtil.exists(e))||(yield r.default.promises.mkdir(e,{recursive:!0})),yield P(e)}))}(E),yield function(e){return i(this,void 0,void 0,(function*(){if(yield p.FsUtil.exists(s.default.resolve(e,"./temp")))throw new Error(`folder "${e}" is not empty(besides directory for logs or uplink)`)}))}(E),(0,a.updateDeployRoot)(E);try{yield function(e,t){return i(this,void 0,void 0,(function*(){yield f.CommonUtil.initTempDir(),yield(0,y.extract)(e,(()=>t),(e=>i(this,void 0,void 0,(function*(){return e.filter(h.isConfigFile)})))).catch((e=>{throw new Error(`fail to extract. "${e}"`)}))}))}(e,F);const t=yield(0,u.parseConfigFile)(F);D=t.logs_path;const r=null!==(o=null!=g?g:t.logs_path)&&void 0!==o?o:"",l=null!==(n=null!=C?C:t.uplink_cache_path)&&void 0!==n?n:"";yield function(e,t,o){return i(this,void 0,void 0,(function*(){const i=[t,o,"./temp"].flatMap((t=>function(e,t){const o=s.default.resolve(t,e),i=[];if(e&&(0,p.isSubdirectory)(o,t)){const e=s.default.relative(t,o).split(s.default.sep)[0];e&&i.push(e)}return i}(t,e))),n=e=>e.isDirectory()&&i.includes(e.name);if(!(yield p.FsUtil.readdir(e,{withFileTypes:!0})).every(n))throw new Error(`folder "${e}" is not empty(besides directory for logs or uplink)`)}))}(E,r,l),g&&(yield P(g)),C&&(yield P(C)),D=g?s.default.resolve(process.cwd(),g):D,yield(0,w.checkLogs)(D)}catch(e){throw yield p.FsUtil.rm(F),yield p.FsUtil.rmdir(s.default.join(E,"/temp")),new Error(e.message)}yield p.FsUtil.rm(F),c.OhpmLazyLogger.info(`start extracting file: ${e}.`),yield(0,h.extractOperation)(e,E,null),c.OhpmLazyLogger.info("extracting file success."),yield function(e,t,o){return i(this,void 0,void 0,(function*(){const i=s.default.join(e,v.PathConstants.CONFIG_PATH);if(!(yield p.FsUtil.exists(i)))throw new Error(`config file "${i}" does not exist`);const n=yield(0,u.parseConfigFile)(i);if(n.db.type===_.DbType.FileDb)throw new Error(`deploy operation does not support "${_.DbType.FileDb}"`);const r=l.load(yield p.FsUtil.readFile(i,"utf-8"));let d,f;t&&(d=s.default.resolve(process.cwd(),t),r[v.ConfigItemNames.LOGS_PATH]=d,(0,a.updateLogsPath)(d),n.logs_path=d),o&&(f=s.default.resolve(process.cwd(),o),r[v.ConfigItemNames.UPLINK_CACHE_PATH]=f,n.uplink_cache_path=f),r[v.ConfigItemNames.DEPLOY_ROOT]=a.Constants.DATA_DIR,n.deploy_root=a.Constants.DATA_DIR;const y=n.ohpm_repo_version;if(!y||!O.default.lte(y,a.Constants.VERSION)||O.default.major(y)!==O.default.major(a.Constants.VERSION))throw new Error(`the pack file cannot be deployed because the version (V${y}) of the ohpm-repo that generates the pack file is later than the current version (V${a.Constants.VERSION}) of the ohpm-repo or the two versions do not belong to the same major version`);return r[v.ConfigItemNames.OHPM_REPO_VERSION]=a.Constants.VERSION,n.ohpm_repo_version=a.Constants.VERSION,O.default.lt(y,a.Constants.VERSION)&&c.OhpmLazyLogger.info(`version upgrade: ohpm-repo's version is upgraded from "${y}" to "${a.Constants.VERSION}".`),(0,u.updateConfig)(n),yield p.FsUtil.writeFile(i,l.dump(r),"utf-8"),n}))}(E,g,C);const I=s.default.join(E,v.PathConstants.CONFIG_PATH);yield(0,u.parseAndUpdateGlobalConfig)(I),yield(0,w.checkAndUpdateConfig)(u.config),u.config.skip_db=!!t.skipDb&&t.skipDb,yield d.MainInit.init(I),yield(0,b.initStorage)(),(0,c.consoleInfo)("deploy successfully."),yield(0,u.setEnvironmentVariable)(a.Constants.DEPLOY_ROOT_ENV,E)}))}function P(e){return i(this,void 0,void 0,(function*(){if(!(yield p.FsUtil.exists(e)))throw new Error(`folder "${e}" does not exist`)}))}exports.deployCmd=function(e,t){return i(this,void 0,void 0,(function*(){try{yield E(e,t)}catch(e){(0,c.consoleError)(`server fail to deploy: ${e}.`),g.default.shutdown((()=>process.exit(1)))}}))},exports.deployExecute=E;