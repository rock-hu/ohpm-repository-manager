"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Multipart=void 0;const e=require("stream"),t=require("../deps/StreamSearch"),i=require("../Utils");class r extends e.Writable{emptyCb(){}constructor(e){if(super({autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.highWaterMark?e.highWaterMark:void 0}),this.ignoreData={push:(e,t)=>{},destroy:()=>{}},!e.conType.params||"string"!=typeof e.conType.params.boundary)throw new Error("Multipart: Boundary not found");const n=e.conType.params.boundary,h="string"==typeof e.defParamCharset&&e.defParamCharset?i.Utils.getDecoder(e.defParamCharset):this.nullDecoder,l=e.defCharset||"utf8",o=e.preservePath,f={autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.fileHwm?e.fileHwm:void 0},c=e.limits,u=c&&"number"==typeof c.fieldSize?c.fieldSize:1048576,_=c&&"number"==typeof c.fileSize?c.fileSize:1/0,m=c&&"number"==typeof c.files?c.files:1/0,p=c&&"number"==typeof c.fields?c.fields:1/0,d=c&&"number"==typeof c.parts?c.parts:1/0;let b,E,S,y,A,R=-1,C=0,w=0,v=!1,U=0,M=0,k=!1,H=!1,D=!1;this._fileEndsLeft=0,this._fileStream=void 0,this._complete=!1,this._hparser=null;const P=new s((e=>{let t;if(this._hparser=null,v=!1,y="text/plain",E=l,S="7bit",A=void 0,k=!1,!e["content-disposition"])return void(v=!0);const r=i.Utils.parseDisposition(e["content-disposition"][0],h);if(r&&"form-data"===r.type){if(r.params&&(r.params.name&&(A=r.params.name),r.params["filename*"]?t=r.params["filename*"]:r.params.filename&&(t=r.params.filename),void 0===t||o||(t=i.Utils.basename(t))),e["content-type"]){const t=i.Utils.parseContentType(e["content-type"][0]);t&&(y=`${t.type}/${t.subtype}`,t.params&&"string"==typeof t.params.charset&&(E=t.params.charset.toLowerCase()))}if(e["content-transfer-encoding"]&&(S=e["content-transfer-encoding"][0].toLowerCase()),"application/octet-stream"===y||void 0!==t){if(w===m)return H||(H=!0,this.emit("filesLimit")),void(v=!0);if(++w,0===this.listenerCount("file"))return void(v=!0);U=0,this._fileStream=new a(f,this),++this._fileEndsLeft,this.emit("file",A,this._fileStream,{filename:t,encoding:S,mimeType:y})}else{if(C===p)return D||(D=!0,this.emit("fieldsLimit")),void(v=!0);if(++C,0===this.listenerCount("field"))return void(v=!0);b=[],M=0}}else v=!0}));let g=0;const L=(e,t,s,a,n)=>{for(;t;){if(null!==this._hparser){const e=this._hparser.push(t,s,a);if(-1===e){this._hparser=null,P.reset(),this.emit("error",new Error("Malformed part header"));break}s=e}if(s===a)break;if(0!==g){if(1===g){switch(t[s]){case 45:g=2,++s;break;case 13:g=3,++s;break;default:g=0}if(s===a)return}if(2===g){if(g=0,45===t[s])return this._complete=!0,void(this._bparser=this.ignoreData);const e=this._writecb;this._writecb=this.emptyCb,L(!1,r.BUF_DASH,0,1,!1),this._writecb=e}else if(3===g){if(g=0,10===t[s]){if(++s,R>=d)break;if(this._hparser=P,s===a)break;continue}{const e=this._writecb;this._writecb=this.emptyCb,L(!1,r.BUF_CR,0,1,!1),this._writecb=e}}}if(!v)if(this._fileStream){let e;const i=Math.min(a-s,_-U);n?e=t.slice(s,s+i):(e=Buffer.allocUnsafe(i),t.copy(e,0,s,s+i)),U+=e.length,U===_?(e.length>0&&this._fileStream.push(e),this._fileStream.emit("limit"),this._fileStream.truncated=!0,v=!0):this._fileStream.push(e)||(this._writecb&&(this._fileStream._readcb=this._writecb),this._writecb=null)}else if(void 0!==b){let e;const i=Math.min(a-s,u-M);n?e=t.slice(s,s+i):(e=Buffer.allocUnsafe(i),t.copy(e,0,s,s+i)),M+=i,b.push(e),M===u&&(v=!0,k=!0)}break}if(e){if(g=1,this._fileStream)this._fileStream.push(null),this._fileStream=null;else if(void 0!==b){let e;switch(b.length){case 0:e="";break;case 1:e=i.Utils.convertToUTF8(b[0],E,0);break;default:e=i.Utils.convertToUTF8(Buffer.concat(b,M),E,0)}b=void 0,M=0,this.emit("field",A,e,{nameTruncated:!1,valueTruncated:k,encoding:S,mimeType:y})}++R===d&&this.emit("partsLimit")}};this._bparser=new t.StreamSearch(`\r\n--${n}`,L),this._writecb=null,this._finalcb=null,this.write(r.BUF_CRLF)}static detect(e){return"multipart"===e.type&&"form-data"===e.subtype}_write(e,t,i){this._writecb=i,this._bparser.push(e,0),this._writecb&&this.callAndUnsetCb(this)}_destroy(e,t){this._hparser=null,this._bparser=this.ignoreData,e||(e=this.checkEndState(this));const i=this._fileStream;i&&(this._fileStream=null,i.destroy(e)),t(e)}_final(e){if(this._bparser.destroy(),!this._complete)return e(new Error("Unexpected end of form"));this._fileEndsLeft?this._finalcb=this.finalcb.bind(null,this,e):this.finalcb(this,e)}callAndUnsetCb(e,t){const i=e._writecb;e._writecb=null,t?e.destroy(t):i&&i()}nullDecoder(e){return e}finalcb(e,t,i){if(i)return t(i);(i=e.checkEndState(e))&&t(i)}checkEndState(e){if(e._hparser)return new Error("Malformed part header");const t=e._fileStream;return t&&(e._fileStream=null,t.destroy(new Error("Unexpected end of file"))),e._complete?void 0:new Error("Unexpected end of form")}}exports.Multipart=r,r.BUF_CRLF=Buffer.from("\r\n"),r.BUF_CR=Buffer.from("\r"),r.BUF_DASH=Buffer.from("-"),r.MAX_HEADER_PAIRS=2e3,r.MAX_HEADER_SIZE=16384,r.HPARSER_NAME=0,r.HPARSER_PRE_OWS=1,r.HPARSER_VALUE=2;class s{constructor(e){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=r.HPARSER_NAME,this.name="",this.value="",this.crlf=0,this.cb=e}reset(){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=r.HPARSER_NAME,this.name="",this.value="",this.crlf=0}push(e,t,s){let a=t;for(;t<s;)switch(this.state){case r.HPARSER_NAME:{let n=!1;for(;t<s;++t){if(this.byteCount===r.MAX_HEADER_SIZE)return-1;++this.byteCount;const s=e[t];if(1!==i.Utils.TOKEN[s]){if(58!==s)return-1;if(this.name+=e.latin1Slice(a,t),0===this.name.length)return-1;++t,n=!0,this.state=r.HPARSER_PRE_OWS;break}}if(!n){this.name+=e.latin1Slice(a,t);break}}case r.HPARSER_PRE_OWS:{let i=!1;for(;t<s;++t){if(this.byteCount===r.MAX_HEADER_SIZE)return-1;++this.byteCount;const s=e[t];if(32!==s&&9!==s){a=t,i=!0,this.state=r.HPARSER_VALUE;break}}if(!i)break}case r.HPARSER_VALUE:switch(this.crlf){case 0:for(;t<s;++t){if(this.byteCount===r.MAX_HEADER_SIZE)return-1;++this.byteCount;const s=e[t];if(1!==i.Utils.FIELD_VCHAR[s]){if(13!==s)return-1;++this.crlf;break}}this.value+=e.latin1Slice(a,t++);break;case 1:if(this.byteCount===r.MAX_HEADER_SIZE)return-1;if(++this.byteCount,10!==e[t++])return-1;++this.crlf;break;case 2:{if(this.byteCount===r.MAX_HEADER_SIZE)return-1;++this.byteCount;const i=e[t];32===i||9===i?(a=t,this.crlf=0):(++this.pairCount<r.MAX_HEADER_PAIRS&&(this.name=this.name.toLowerCase(),void 0===this.header[this.name]?this.header[this.name]=[this.value]:this.header[this.name].push(this.value)),13===i?(++this.crlf,++t):(a=t,this.crlf=0,this.state=r.HPARSER_NAME,this.name="",this.value=""));break}case 3:{if(this.byteCount===r.MAX_HEADER_SIZE)return-1;if(++this.byteCount,10!==e[t++])return-1;const i=this.header;return this.reset(),this.cb(i),t}}}return t}}class a extends e.Readable{constructor(e,t){super(e),this.truncated=!1,this._readcb=null,this.once("end",(()=>{if(this._read(),0==--t._fileEndsLeft&&t._finalcb){const e=t._finalcb;t._finalcb=null,process.nextTick(e)}}))}_read(){const e=this._readcb;e&&(this._readcb=null,e())}}