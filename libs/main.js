"use strict";var e=this&&this.__createBinding||(Object.create?function(e,r,o,t){void 0===t&&(t=o);var i=Object.getOwnPropertyDescriptor(r,o);i&&!("get"in i?!r.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return r[o]}}),Object.defineProperty(e,t,i)}:function(e,r,o,t){void 0===t&&(t=o),e[t]=r[o]}),r=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),o=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var t={};if(null!=o)for(var i in o)"default"!==i&&Object.prototype.hasOwnProperty.call(o,i)&&e(t,o,i);return r(t,o),t},t=this&&this.__awaiter||function(e,r,o,t){return new(o||(o=Promise))((function(i,n){function l(e){try{a(t.next(e))}catch(e){n(e)}}function s(e){try{a(t.throw(e))}catch(e){n(e)}}function a(e){var r;e.done?i(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(l,s)}a((t=t.apply(e,r||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkRunInstallBefore=exports.start=void 0;const n=require("./common"),l=i(require("body-parser")),s=require("./service/group/GroupController"),a=i(require("cookie-parser")),c=require("./packages/config/config"),u=i(require("path")),p=require("./utils/FsUtil"),d=require("./packages/log"),g=require("./common/RepoError"),f=require("./service/package/PackageController"),h=require("./service/uplinks/UplinkController"),m=require("./service/publicKeyAuth/PublicKeyController"),y=require("./service/user/UserController"),v=require("./service/userLogin/UserLoginController"),C=require("./service/client/ClientController"),q=require("./service/uplinks/uplink-proxy/UplinkProxyController"),_=require("./service/uplinks/uplink-storage/UplinkStorageController"),k=require("./service/system/KeyManageController"),R=i(require("log4js")),O=require("./service/localStorage/StorageController"),P=require("./common/Constants"),S=require("./service/repo/RepoController"),F=require("./common/RepoResponse"),U=require("./service/filter/MethodFilterController"),A=require("./common/DbFactory"),b=require("./common/FSFactory"),I=require("./service/user/UserService"),L=require("./commands/install"),w=require("./packages/config/checker"),x=require("./packages/config/constants"),E=require("./service/uplinks/uplink-storage/UplinkStorage"),j=require("./service/validator"),D=o(require("js-yaml")),M=i(require("semver")),T=require("./service/accessToken/AccessTokenController"),N=require("./service/security/SecurityController"),H=require("./service/schedule"),z=require("./service/adminAuditLog/AdminAuditLogController"),K=require("./middle-ware");function B(e,r,o,t){e.err?d.OhpmLazyLogger.error(`errorHandler, ${e.message}`,e.err):d.OhpmLazyLogger.error("errorHandler,",e.message),e instanceof g.RepoError?F.RepoResponse.fail(o,e.status,e.response()):F.RepoResponse.systemError(o)}function G(){return t(this,void 0,void 0,(function*(){const e=yield(0,L.readCongFileFromEnv)(),r=u.default.join(P.Constants.WORK_DIR,x.PathConstants.RUNTIME_PATH);if(!(yield p.FsUtil.exists(e))||!(yield p.FsUtil.exists(r)))throw new Error('please run "ohpm-repo install" command before running "ohpm-repo start" command');const o=P.Constants.VERSION,t=yield p.FsUtil.readFile(e,"utf8"),i=D.load(t),n=i.ohpm_repo_version?i.ohpm_repo_version.toString():"";if(0===n.length||!M.default.eq(o,n))throw new Error('the version of the ohpm-repo during the execution of "ohpm-repo install" command is not consistent with the version during the execution of "ohpm-repo start" command, please run "ohpm-repo install" command again')}))}exports.start=function(){return t(this,void 0,void 0,(function*(){const e=process.env.OHPM_REPO_DEPLOY_ROOT;(0,L.checkNonRootPermission)("start");const r=yield(0,L.readCongFileFromEnv)();yield G(),yield(0,c.parseAndUpdateGlobalConfig)(r),yield(0,w.checkAndUpdateConfig)(c.config),(0,P.updateDeployRoot)(e),(0,P.updateLogsPath)(c.config.logs_path),d.OhpmLazyLogger.info(`config file path: "${r}".`),yield(0,A.initDB)(c.config.db),yield(0,b.initStorage)(),yield(0,H.initSchedule)(),yield E.uplinkStorage.init(),yield I.userService.addAdminUser(),yield function(){return t(this,void 0,void 0,(function*(){const e=R.default.connectLogger(d.OhpmLazyLogger.getAccessLogger(),{level:"info"}),r=new n.AppServer([K.timeoutHandler,e,(0,a.default)(),l.default.json({limit:"1024mb"}),K.initCtx,K.initRes,K.checkPageNumAndPageSize,K.antiReplay],[U.methodFilterController,y.userController,v.userLoginController,m.publicKeyController,s.groupController,(0,S.repoController)(),f.packageController,h.uplinkController,q.uplinkProxyController,j.ValidationConfigController.getInstance(),z.AdminAuditLogController.getInstance(),_.uplinkStorageController,C.clientController,O.storageController,k.keyManageController,T.AccessTokenController.getInstance(),N.SecurityController.getInstance()],[B]),o=u.default.join(__dirname,"../public");(yield p.FsUtil.exists(o))&&r.static("/",o),process.on("uncaughtException",(e=>{d.OhpmLazyLogger.warn("process uncaughtException",e)}));const t=c.config.listen;try{yield r.listen(t.host,t.port,t.proto)}catch(e){throw new Error("fail to create server")}}))}(),yield function(){return t(this,void 0,void 0,(function*(){const e=u.default.join(P.Constants.DATA_DIR,x.PathConstants.RUNTIME_PID_PATH);yield p.FsUtil.createFileIfNotExists(e),yield p.FsUtil.writeFile(e,process.pid.toString()),yield p.FsUtil.chmod(e,P.Constants.PERMISSIONS640);const r=u.default.join(P.Constants.DATA_DIR,x.PathConstants.RUNTIME_BINARY_ROOT_PATH);yield p.FsUtil.writeFile(r,P.Constants.WORK_DIR),yield p.FsUtil.chmod(r,P.Constants.PERMISSIONS640)}))}()}))},exports.checkRunInstallBefore=G;