"use strict";var e=this&&this.__awaiter||function(e,o,t,n){return new(t||(t=Promise))((function(r,s){function i(e){try{d(n.next(e))}catch(e){s(e)}}function c(e){try{d(n.throw(e))}catch(e){s(e)}}function d(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(i,c)}d((n=n.apply(e,o||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AccessTokenService=void 0;const t=require("../../common/RepoError"),n=require("./AccessTokenRepository"),r=require("../../common/AccessTokenType"),s=require("../../entity/AccessToken"),i=require("../../common"),c=require("../../common/ErrorCode"),d=o(require("lodash")),T=require("../../utils/CommonUtil");class u{static getInstance(){if(!this.Instance){const e=n.AccessTokenRepository.getInstance();this.Instance=new u(e)}return this.Instance}constructor(e){this.accessTokenRepository=e}generateAccessToken(o,n){var d;return e(this,void 0,void 0,(function*(){const{total:e}=null!==(d=yield this.accessTokenRepository.findByUserIdAndType(o,n))&&void 0!==d?d:{total:0};if(e>=u.MAX_TOKEN_BY_TYPE)throw new t.RepoClientError(i.ErrorCode.ExceedTypeTokenMaximum,`${c.MESSAGE_CN[i.ErrorCode.ExceedTypeTokenMaximum]}: ${u.MAX_TOKEN_BY_TYPE}`);let a;switch(n){case r.AccessTokenType.READ_ONLY:a=new s.AccessToken(r.AccessTokenType.READ_ONLY,o);break;case r.AccessTokenType.READ_WRITE:a=new s.AccessToken(r.AccessTokenType.READ_WRITE,o);break;default:throw new t.RepoClientError(i.ErrorCode.NotFoundTokenType,c.MESSAGE_CN[i.ErrorCode.NotFoundTokenType])}const l=a.token;return a.token=T.CommonUtil.sha256(l),yield this.accessTokenRepository.insert(a),l}))}getUserIdByTokenAndType(o,n){var s;return e(this,void 0,void 0,(function*(){if(!r.AccessTokenTypeMap[n])throw new t.RepoClientError(i.ErrorCode.NotFoundTokenType,c.MESSAGE_CN[i.ErrorCode.NotFoundTokenType]);o=T.CommonUtil.sha256(o);const{recordList:e}=yield this.accessTokenRepository.findByTokenAndType(o,n);return null===(s=e[0])||void 0===s?void 0:s.userId}))}getAccessTokenListByUserId(o,t){var n;return e(this,void 0,void 0,(function*(){const e=null!==(n=yield this.accessTokenRepository.findByUserId(o,t.getCurrentPage(),t.getPageSize()))&&void 0!==n?n:{total:0,recordList:[]},r=d.default.cloneDeep(e);for(const e of r.recordList)e.token=e.sanitizedToken,delete e.sanitizedToken,delete e.salt;return r}))}deleteAccessToken(o,n){var r;return e(this,void 0,void 0,(function*(){const{total:e}=null!==(r=yield this.accessTokenRepository.findByIdAndUserId(n,o))&&void 0!==r?r:{total:0};if(0===e)throw new t.RepoClientError(i.ErrorCode.NotMatchTokenAndUser,c.MESSAGE_CN[i.ErrorCode.NotMatchTokenAndUser]);return this.accessTokenRepository.deleteById(n)}))}deleteAccessTokenByUserId(o){return e(this,void 0,void 0,(function*(){return this.accessTokenRepository.deleteByUserId(o)}))}getAllAccessToken(){return e(this,void 0,void 0,(function*(){return this.accessTokenRepository.findAll()}))}updateAccessToken(o){return e(this,void 0,void 0,(function*(){yield this.accessTokenRepository.updateAccessToken(o)}))}}exports.AccessTokenService=u,u.MAX_TOKEN_BY_TYPE=10;