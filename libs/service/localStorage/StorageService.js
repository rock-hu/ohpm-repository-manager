"use strict";var e=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(n,i){function a(e){try{l(r.next(e))}catch(e){i(e)}}function s(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.StorageService=void 0;const t=require("../../common/Constants"),o=require("../../common/RepoError"),r=require("../../common"),n=require("../../packages/log"),i=require("../../common/FSFactory"),a=require("../client/install/InstallService"),s=require("../package/PackageRepository"),l=require("../../packages/config/config"),d=require("../../common/DbAndStoreType");class c{static getDownloadFileBuffer(a,s){return e(this,void 0,void 0,(function*(){if(decodeURIComponent(a).includes(".."))throw n.OhpmLazyLogger.error('the download url includes ".."!'),new o.RepoClientError(r.ErrorCode.LocalStorageError,"The download url is invalid");const e=yield c.getFileId(s),l=yield i.FsFactory.getInstance(),d=yield l.download(e);return s.fileName.endsWith(t.Constants.HAR_SUFFIX)&&(yield this.installService.increaseDownloads(s)),d}))}static getDownloadFileStream(a,s){return e(this,void 0,void 0,(function*(){let e;try{if(decodeURIComponent(a).includes(".."))throw n.OhpmLazyLogger.error('the download url includes ".."!'),new o.RepoClientError(r.ErrorCode.LocalStorageError,"The download url is invalid");const l=yield c.getFileId(s),d=yield i.FsFactory.getInstance();return e=yield d.downloadStream(l),s.fileName.endsWith(t.Constants.HAR_SUFFIX)&&(yield this.installService.increaseDownloads(s)),e}catch(t){throw null==e||e.destroy(),t}}))}static getDownloadFileUrl(o){return e(this,void 0,void 0,(function*(){if(l.config.store.type!==d.StorageType.Custom)throw new Error(`only ${d.StorageType.Custom} store support getDownloadFileUrl method`);const e=yield c.getFileId(o),r=yield i.FsFactory.getInstance(),n=yield r.getDownloadUrl(e);return o.fileName.endsWith(t.Constants.HAR_SUFFIX)&&(yield this.installService.increaseDownloads(o)),n}))}static getFileId(o){return e(this,void 0,void 0,(function*(){const e=o.repoName,r=o.getPackageName(),n=o.getVersion(),i=yield s.packageRepository.getManifestByName(e,r,n);if(!i||!i.recordList||0===i.recordList.length)throw new Error(`not such package by downloadMeta: ${JSON.stringify(o)}`);const a=i.recordList[0],l=o.fileName;if(l===t.Constants.README_FILE_NAME)return a.readmeFileId;if(l===t.Constants.CHANGELOG_FILE_NAME)return a.changelogFileId;if(l.endsWith(t.Constants.HAR_SUFFIX))return a.harFileId;if(l.endsWith(t.Constants.HSP_SUFFIX))return a.hspFileId;throw new Error(`not such fileId by downloadMeta: ${JSON.stringify(o)}`)}))}static getDownloadFileName(e){return(e.fileName.endsWith(t.Constants.HSP_SUFFIX)||e.fileName.endsWith(t.Constants.HAR_SUFFIX))&&e.group?`${e.group}-${e.fileName}`:e.fileName}}exports.StorageService=c,c.installService=a.InstallService.getInstance();