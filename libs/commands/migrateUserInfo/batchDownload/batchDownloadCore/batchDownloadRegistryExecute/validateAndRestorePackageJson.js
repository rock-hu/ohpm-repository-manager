"use strict";var e=this&&this.__awaiter||function(e,i,a,r){return new(a||(a=Promise))((function(t,l){function d(e){try{n(r.next(e))}catch(e){l(e)}}function o(e){try{n(r.throw(e))}catch(e){l(e)}}function n(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(e){e(i)}))).then(d,o)}n((r=r.apply(e,i||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateAndRestorePackageJson=void 0;const a=i(require("path")),r=require("../../../../../service/validator/ValidatorFactory"),t=require("../../../../../utils/CommonConstants"),l=require("../../../../../utils/FsUtil"),d=require("../../../common/updateSilentRuleErrorMaps"),o=require("./dealPackageJsonField/preDealAuthorField"),n=require("./dealPackageJsonField/preDealKeywordsField"),s=require("./validatePackageField/validateMainField"),c=require("./validatePackageField/validateTypesField"),u=require("../../../../../packages/log"),F=require("../../../common/objectValueUtilByPath"),p=require("../../../definitions"),y=require("./dealPackageJsonField/getAttrNameFirstKey"),f=require("./dealPackageJsonField/dealDescriptionField"),g=require("./dealPackageJsonField/dealFieldToStringEmpty"),k=require("./dealPackageJsonField/dealKeywordsField"),h=require("./dealPackageJsonField/dealHomepageField"),v=require("./dealPackageJsonField/dealRepositoryField"),q=require("./dealPackageJsonField/dealLicenseField"),P=require("./dealPackageJsonField/dealTypesField"),J=require("./dealPackageJsonField/dealMainField"),m=require("./dealPackageJsonField/dealArtifactTypeField");function w(e,i,a,r){switch((0,y.getAttrNameFirstKey)(e)){case"description":(0,f.dealDescriptionField)(e,i,a);break;case"author":(0,g.dealFieldToStringEmpty)(e,i,a);break;case"keywords":(0,k.dealKeywordsField)(e,i,a);break;case"homepage":(0,h.dealHomepageField)(e,i,a);break;case"repository":(0,v.dealRepositoryField)(e,i,a);break;case"license":(0,q.dealLicenseField)(e,i,a);break;case"types":(0,P.dealTypesField)(e,i,a);break;case"main":(0,J.dealMainField)(e,i,a,r);break;case"artifactType":(0,m.dealArtifactTypeField)(e,i,a)}}function A(e){let i=e;return e.includes(".")&&(i=e.slice(0,e.indexOf("."))),p.OhPackageJsonRequireAttrs.includes(i)}exports.validateAndRestorePackageJson=function(i,y){return e(this,void 0,void 0,(function*(){const f=a.default.join(i,t.OH_PACKAGE_JSON),g=a.default.join(i,t.PACKAGE_JSON),k=yield function(i,a,r){return e(this,void 0,void 0,(function*(){let e;if(yield l.FsUtil.exists(i))e=yield l.FsUtil.readJSON5(i);else{if(!(yield l.FsUtil.exists(a)))throw new Error(`"${r}" ${t.OH_PACKAGE_JSON} file is not found`);e=yield l.FsUtil.readJSON5(a)}return e}))}(f,g,y),h=new Map;(0,o.preDealAuthorField)(k),(0,n.preDealKeywordsField)(k);const v=r.ValidatorFactory.createDefaultValidator(((e,i)=>{(0,d.updateSilentRuleErrorMaps)(e,i,h)}));yield v.validate(k),(0,c.validateTypesField)(i,k,h),(0,s.validateMainField)(i,k,h);let q="";for(const e of h.keys()){!q&&A(e)&&(q=e);const a=h.get(e);null==a||a.forEach((i=>{u.OhpmLazyLogger.warn(`package "${y}":`,`${i.errorMsg}, value: ${JSON.stringify((0,F.getValueByAttrName)(k,e))}`)})),w(e,y,k,i)}if(!k.main&&!k.types)throw new Error(`> Failed to convert the "${y}" package, required "main" or "types" field validation failed.`);if(q.length)throw new Error(`> Failed to convert the "${y}" package, required "${q}" field validation failed.`);const P={};for(const e of p.NeedConvertAttrs)Object.prototype.hasOwnProperty.call(k,e)&&(P[e]=k[e]);yield l.FsUtil.writeFile(f,JSON.stringify(P,null,2)),(yield l.FsUtil.exists(g))&&(yield l.FsUtil.rm(g))}))};