"use strict";var e=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageValidatorImpl=void 0;const n=require("./repository"),r=t(require("./DefaultValidationConfig.json")),i=require("./factory"),o=require("./rule/ValidationConfigChecker"),a=require("../../common/RepoError"),s=require("../../common"),l=(e,t)=>{throw new a.RepoClientError(s.ErrorCode.ValidatePublishJsonError,t.errorMsg,t.err,t.extInfo)};class c{constructor(e,t){this.errorCallback=t||l,e&&(this.repository=e),this.defaultHandlersMap=new Map}static getInstance(){return this.Instance||(this.Instance=new c(n.ValidationConfigDBRepository.getInstance()),this.Instance.loadDefaultConfig()),this.Instance}getHandlers(){return e(this,void 0,void 0,(function*(){const e=new Map;if(this.repository){const t=yield this.repository.findAllConfigs();this.updateHandlersMap(t,e)}return this.defaultHandlersMap.forEach(((t,n)=>{const r=e.get(n);if(r){r.getTail().setNext(t)}else e.set(n,t)})),e}))}validate(t,n){return e(this,void 0,void 0,(function*(){const e=yield this.getHandlers();for(const[r,i]of e.entries())n&&!n.includes(r)||i.validate(t,r)}))}loadDefaultConfig(){const e=new n.DefaultConfigFileRepository(r.default).findAllConfigs();e.forEach((e=>o.ValidationConfigChecker.checkConfig(e.toValidationConfig()))),this.updateHandlersMap(e,this.defaultHandlersMap)}updateHandlersMap(e,t){e.forEach((e=>{const n=e.toValidationConfig(),r=i.ValidationRuleHandlerFactory.createHandler(n,this.errorCallback);t.set(e.attrName,r)}))}}exports.PackageValidatorImpl=c;