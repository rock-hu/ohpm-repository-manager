"use strict";var e=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function a(e){try{s(o.next(e))}catch(e){n(e)}}function c(e){try{s(o.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.downloadTarBall=void 0;const r=require("../../../../../../concurrent/ConcurrentExecutor"),o=require("../../../../../../packages/log"),i=t(require("path")),n=require("../../../../definitions"),a=t(require("node-fetch")),c=require("../../../../common/getPublicRegistryAgent"),s=require("../index"),u=require("../../../../../../common/Constants"),l=require("../../../../../../utils/FsUtil"),d=require("../../../../../../service/client/publish/PublishService");function f(t,r,n,a,c){return e(this,void 0,void 0,(function*(){const e=r.replace("/","+"),s=i.default.join(n,e+u.Constants.TGZ_SUFFIX);try{o.OhpmLazyLogger.info(`Downloading the "${r}" from ${t.tarball}.`),yield h(s,r,t)}catch(e){const t=`Download "${r}" error: ${e.message}`;o.OhpmLazyLogger.error(t),a.push(r),c.push(t)}}))}function h(t,r,i,n=0){return e(this,void 0,void 0,(function*(){const{tarball:s}=i;try{let o=yield(0,a.default)(s,{agent:(0,c.getPublicRegistryAgent)(s),redirect:"manual"});const n=[301,302].includes(o.status);if(!o.ok&&!n)throw new Error(`failed to download the "${r}" package from ${s}.`);const u=o.headers.get("Location");if(n&&u&&(o=yield(0,a.default)(u,{agent:(0,c.getPublicRegistryAgent)(u)}),!o.ok))throw new Error(`failed to download the "${r}" package from ${u}.`);const f=l.FsUtil.createWriteStream(t);let h;o.body.pipe(f);const y=new Promise(((e,t)=>{h=setTimeout((()=>{clearTimeout(h),f.destroy(),t(new Error(`download timed out for "${r}" after 60000ms`))}),6e4)})),m=new Promise(((o,n)=>{f.on("error",(e=>{clearTimeout(h),n(e)})),f.on("close",(()=>e(this,void 0,void 0,(function*(){clearTimeout(h),yield function(t,r,o,i,n){return e(this,void 0,void 0,(function*(){(yield function(t,r){return e(this,void 0,void 0,(function*(){try{if(!(yield l.FsUtil.exists(t)))return!1;const e=yield d.publishService.calculatedChecksum(t);return r===e}catch(e){return!1}}))}(i,o.integrity))?t():r(new Error(`Failed to download the "${n}" package from ${o.tarball}, integrity check failed.`))}))}(o,n,i,t,r)}))))}));yield Promise.race([y,m])}catch(a){if(!(n<3))throw a;o.OhpmLazyLogger.warn(`An error occurred while downloading "${r}" from ${i.tarball}, ${a.message}, retrying (${n+1}/3)...`),yield function(t){return e(this,void 0,void 0,(function*(){(yield l.FsUtil.exists(t))&&(yield l.FsUtil.rm(t))}))}(t),yield h(t,r,i,n+1)}}))}exports.downloadTarBall=function(t,o,a){return e(this,void 0,void 0,(function*(){const c=i.default.join(o,n.PmDir);yield l.FsUtil.createDirIfNotExists(c);const u=[],d=r.ConcurrentExecutor.creatInstance();for(const[r,o]of t.entries())d.addAsyncTask((()=>e(this,void 0,void 0,(function*(){return f(o,r,c,u,a)}))));const{retryInterval:h,maxConcurrent:y,retryTimes:m}=s.batchDownloadRegistryLocalData;return yield d.runWithErrorHandle(y,m,h),u}))};