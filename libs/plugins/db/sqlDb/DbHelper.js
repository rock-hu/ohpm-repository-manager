"use strict";var e=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))((function(o,n){function d(e){try{u(i.next(e))}catch(e){n(e)}}function a(e){try{u(i.throw(e))}catch(e){n(e)}}function u(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(d,a)}u((i=i.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OperatorMap=exports.DbHelper=void 0;const r=require("../../../packages/definitions/types"),t=require("./DbConnect"),i=require("../../../packages/config/init"),o=require("../../../common/RepoError"),n=require("../../../common"),d=require("typeorm");class a{static getInstance(r){return e(this,void 0,void 0,(function*(){return yield(0,t.initConnect)(r),yield t.dataSource.initialize(),new a}))}hasTable(r){return e(this,void 0,void 0,(function*(){return t.dataSource.createQueryRunner().hasTable(r)}))}clearTable(r,d=!1){return e(this,void 0,void 0,(function*(){if(!d&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");return t.dataSource.manager.clear(t.EntityMap[r])}))}deleteByKey(r,d,a,u=!1){return e(this,void 0,void 0,(function*(){if(!u&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");return t.dataSource.manager.delete(t.EntityMap[r],{[a]:d})}))}deleteByQueryFilter(r,d,a){return e(this,void 0,void 0,(function*(){if(!a&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");let e=t.dataSource.manager.createQueryBuilder();e=e.delete().from(t.EntityMap[r],r),yield this.builderFilter(e,d),yield e.execute()}))}deleteById(r,d,a=!1){return e(this,void 0,void 0,(function*(){if(!a&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");return t.dataSource.manager.delete(t.EntityMap[r],{id:d})}))}deleteByRangeKey(r,a,u,s,c=!1){return e(this,void 0,void 0,(function*(){if(!c&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");let e;return e=void 0===s?(0,d.MoreThan)(u):(0,d.Between)(u,s),t.dataSource.manager.delete(t.EntityMap[r],{[a]:e})}))}findByFilter(r,i){return e(this,void 0,void 0,(function*(){const e=t.dataSource.manager.createQueryBuilder();i&&i.pick?e.select(i.pick):e.select(),e.from(t.EntityMap[r],r),i&&i.filter&&(yield this.builderFilter(e,i.filter));let o=0;i&&i.orderBy&&(yield this.builderOrderBy(e,i.orderBy)),i&&i.pageQuery&&(e.skip((i.pageQuery.pageNum-1)*i.pageQuery.pageSize).take(i.pageQuery.pageSize),o=yield e.getCount());const n=yield e.getRawMany();return o=o>0?o:n.length,{total:o,recordList:n}}))}findById(r,i){return e(this,void 0,void 0,(function*(){return t.dataSource.manager.findOne(t.EntityMap[r],{where:{id:i}})}))}insertOne(r,d,a=!1){return e(this,void 0,void 0,(function*(){if(!a&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");return t.dataSource.manager.insert(t.EntityMap[r],d)}))}updateById(r,d,a,u=!1){return e(this,void 0,void 0,(function*(){if(!u&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");return t.dataSource.manager.update(t.EntityMap[r],d,a)}))}upsertOne(r,d,a=!1){return e(this,void 0,void 0,(function*(){if(!a&&!(yield(0,i.judgeReadWriteMode)()))throw new o.RepoServerError(n.ErrorCode.NoModifyPermission,"mode input is readOnly, can not modify data");return t.dataSource.manager.save(t.EntityMap[r],d)}))}builderFilter(r,t){return e(this,void 0,void 0,(function*(){Object.keys(t).forEach(((e,i)=>{const o=t[e];"object"==typeof o?this.builderWhere(r,i,o,e):i>0?r.andWhere(`${e} = :${e}`,{[e]:t[e]}):r.where(`${e} = :${e}`,{[e]:t[e]})}))}))}builderWhere(r,t,i,o){return e(this,void 0,void 0,(function*(){Object.keys(i).forEach(((e,n)=>{const d="contains"===e||"containsIgnoreCase"===e;let a,u=i[e];d?(u=`%${u}%`,a="containsIgnoreCase"===e?`LOWER(${o}) ${exports.OperatorMap[e]} LOWER(:${o}${n})`:`${o} ${exports.OperatorMap[e]} :${o}${n}`):a="in"===e||"nin"===e?`${o} ${exports.OperatorMap[e]} (:...${o}${n})`:`${o} ${exports.OperatorMap[e]} :${o}${n}`,t>0||n>0?r.andWhere(a,{[`${o}${n}`]:u}):r.where(a,{[`${o}${n}`]:u})}))}))}builderOrderBy(t,i){return e(this,void 0,void 0,(function*(){i.keyList.forEach(((e,o)=>{const n=i.orderList[o];o>0?t.addOrderBy(e,n===r.OrderType.ASC?"ASC":"DESC"):t.orderBy(e,n===r.OrderType.ASC?"ASC":"DESC")}))}))}}exports.DbHelper=a,exports.OperatorMap={eq:"=",ne:"!=",gt:">",gte:">=",lt:"<",lte:"<=",in:"in",nin:"not in",contains:"like",containsIgnoreCase:"like"};