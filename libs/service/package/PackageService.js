"use strict";var e=this&&this.__awaiter||function(e,t,a,i){return new(a||(a=Promise))((function(s,n){function o(e){try{l(i.next(e))}catch(e){n(e)}}function r(e){try{l(i.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.packageService=void 0;const a=require("./PackageRepository"),i=require("./PackageDetailVO"),s=require("../../utils/CommonUtil"),n=require("../../packages/definitions/types"),o=require("../../plugins/storage/types"),r=require("../../plugins/storage/getFileKey"),l=require("../../plugins/storage/getDownloadUrl"),c=require("../client/dist-tags/DistTagsService"),d=t(require("semver")),g=require("../client/publish/PublishRepository"),p=require("../../common/FSFactory"),m=require("../../common/RepoError"),u=require("../../common"),y=require("../client/install/InstallService");exports.packageService=new class{constructor(){this.distTagsService=c.DistTagsService.getInstance(),this.installService=y.InstallService.getInstance()}getPackageList(t){return e(this,void 0,void 0,(function*(){const e=t.getName(),i=t.getCurrentPage(),n=t.getPageSize();let o,r=yield a.packageRepository.getPackageList(i,n),l=r.total;if(0===l&&!e)return o=null,{total:l,packageList:o};e&&(r=yield a.packageRepository.getPackageListByName(e,i,n));const c=r.recordList.map((e=>({id:s.CommonUtil.sha256(`${e.repoName}:${e.name}:${e.latestVersion}`),name:e.name,description:e.description,org:e.group,authorName:e.authorName,publisherName:e.publisherName,authorPicUrl:e.authorPicUrl,latestVersion:e.latestVersion,latestPublishTime:e.latestPublishTime,license:e.license,keywords:s.CommonUtil.compatibleKeyword(e.keywords)})));return l=r.total,o=c,{total:l,packageList:o}}))}getPackageDetail(t){return e(this,void 0,void 0,(function*(){const e=yield a.packageRepository.getManifestById(t);if(!e)return{data:[]};const s=e.repoName,n=new i.PackageDetailVO(e);n.downloads=e.downloads,n.publisherName=e.publisherName,n.readmeUrl&&(n.readmeUrl=yield(0,l.getDownloadUrl)((0,r.getFileKey)(s,n.name,n.version,o.FileType.README,e.groupName))),n.changelogUrl&&(n.changelogUrl=yield(0,l.getDownloadUrl)((0,r.getFileKey)(s,n.name,n.version,o.FileType.CHANGELOG,e.groupName)));const c=yield a.packageRepository.getVersionListByName(n.repoName,n.name);n.versions=yield this.getPackageVersions(n.repoName,n.name,c.recordList),n.latestWeekDownload=yield this.installService.fetchLatestWeekDownloadDataForPackage(n.repoName,n.name),n.isLatestVersion=this.checkIsLatestVersion(n.version,c.recordList),n.isLatestVersion&&(n.latestAnnualWeekDownload=yield this.installService.fetchAnnualWeeklyDownloadsForPackage(n.repoName,n.name));const d=yield this.getDependentList(t);yield this.assembleDependents(n,d);const m=yield g.publishRepository.selectPackageMetaDataByName(s,e.name);if(m){const e=yield p.FsFactory.getInstance(),t=yield e.download(m.metaJsonFileId),a=JSON.parse(t.toString()).versions[n.version];yield this.assembleDependency(n,a)}return n}))}assembleDependency(t,a){return e(this,void 0,void 0,(function*(){const e=yield this.getDepList(a.dependencies,t.repoName);t.dependencies={total:e.length,pageNum:1,pageSize:50,data:e.slice(0,50),pages:Math.ceil(e.length/50)};const i=yield this.getDepList(a.devDependencies,t.repoName);t.devDependencies={total:i.length,pageNum:1,pageSize:50,data:i.slice(0,50),pages:Math.ceil(i.length/50)};const s=yield this.getDepList(a.dynamicDependencies,t.repoName);t.dynamicDependencies={total:s.length,pageNum:1,pageSize:50,data:s.slice(0,50),pages:Math.ceil(s.length/50)}}))}getPackageVersions(t,a,i){return e(this,void 0,void 0,(function*(){const e=yield this.distTagsService.getDistTagsArray(t,a),s=i.map((e=>e.version)),n=d.default.maxSatisfying(s,"*")||d.default.maxSatisfying(s,"*",{includePrerelease:!0,loose:!0});return i.forEach((t=>{t.version===n&&(t.tags=t.tags||[],t.tags.push("latest")),e.forEach((e=>{e.version===t.version&&(t.tags=t.tags||[],t.tags.push(e.tag))}))})),i}))}getDepList(t,i){return e(this,void 0,void 0,(function*(){const e=[];t=null!=t?t:{};for(const n of Object.keys(t)){const t=yield a.packageRepository.getMetadataByName(i,n);let o;if(t&&t.recordList&&t.recordList.length>0){const e=t.recordList[0];o=s.CommonUtil.sha256(`${e.repoName}:${e.name}:${e.latestVersion}`)}e.push({id:o,name:n})}return e}))}checkIsLatestVersion(e,t){const a=t.map((e=>e.version));return(d.default.maxSatisfying(a,"*")||d.default.maxSatisfying(a,"*",{includePrerelease:!0,loose:!0}))===e}getPageDepList(t,s,o,r){return e(this,void 0,void 0,(function*(){const e=yield a.packageRepository.getManifestById(t);let l=[];if(e){const t=new i.PackageDetailVO(e),a=yield g.publishRepository.selectPackageMetaDataByName(t.repoName,t.name);if(!a)throw new m.RepoClientError(u.ErrorCode.pkgMetadataInDBNotExist,`repo "${t.repoName}" pkg "${t.name}" not found in DB`);const s=yield p.FsFactory.getInstance(),o=yield s.download(a.metaJsonFileId),c=JSON.parse(o.toString()).versions[t.version];let d;r===n.DepType.NORMAL?d=c.dependencies:r===n.DepType.DEV?d=c.devDependencies:r===n.DepType.DYNAMIC&&(d=c.dynamicDependencies),l=yield this.getDepList(d,t.repoName)}return{total:l.length,pageNum:s,pageSize:o,data:l.slice((s-1)*o,s*o),pages:Math.ceil(l.length/50)}}))}assembleDependents(t,i){return e(this,void 0,void 0,(function*(){for(let e=0;e<i.length;e++){const n=yield a.packageRepository.getMetadataByName(t.repoName,i[e].name);let o;if(n&&n.recordList&&n.recordList.length>0){const e=n.recordList[0];o=s.CommonUtil.sha256(`${e.repoName}:${e.name}:${e.latestVersion}`)}i[e].id=o}t.dependents={total:i.length,pageNum:1,pageSize:50,data:i.length>50?i.slice(0,50):i,pages:Math.ceil(1)}}))}getDependentList(t){return e(this,void 0,void 0,(function*(){const e=yield a.packageRepository.getManifestById(t);if(!e)return[];const i=e.name,s=yield a.packageRepository.getNameByDepPackageName(i),n=new Map(s.map((e=>[e.name,e])));return Array.from(n.values())}))}getPageDependentList(t,n,o){return e(this,void 0,void 0,(function*(){const e=yield a.packageRepository.getManifestById(t),r=yield this.getDependentList(t);if(e){const t=new i.PackageDetailVO(e);for(let e=0;e<r.length;e++){const i=yield a.packageRepository.getMetadataByName(t.repoName,r[e].name);let n;if(i&&i.recordList&&i.recordList.length>0){const e=i.recordList[0];n=s.CommonUtil.sha256(`${e.repoName}:${e.name}:${e.latestVersion}`)}r[e].id=n}}return{total:r.length,pageNum:n,pageSize:o,data:r.slice((n-1)*o,n*o),pages:Math.ceil(r.length/50)}}))}};