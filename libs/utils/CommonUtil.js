"use strict";var t=this&&this.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),e=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var i={};if(null!=r)for(var n in r)"default"!==n&&Object.prototype.hasOwnProperty.call(r,n)&&t(i,r,n);return e(i,r),i},i=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonUtil=void 0;const o=require("./FsUtil"),s=n(require("path")),a=require("../common/Constants"),c=require("./RandomUtil"),l=r(require("crypto")),u=require("../packages/config/config"),d=n(require("os")),f=require("../packages/log"),h=n(require("tar")),p=require("../common/RepoError"),g=require("../common");class m{static getBeiJingTimeIsoStr(){return new Date((new Date).getTime()+288e5).toISOString().replace("Z","+08:00")}static initTempDir(){return i(this,void 0,void 0,(function*(){try{yield o.FsUtil.createDirIfNotExists(s.default.join(a.Constants.DATA_DIR,"temp")),yield o.FsUtil.chmod(s.default.join(a.Constants.DATA_DIR,"temp"),488)}catch(t){f.OhpmLazyLogger.error("temporary folder permissions fail to be assigned.")}}))}static genRandomTempDir(){const t=s.default.join(a.Constants.DATA_DIR,"temp");return s.default.join(t,c.RandomUtil.generateSecureRandomString(32))}static downloadUrl(t,e){return i(this,void 0,void 0,(function*(){const r=yield o.FsUtil.fetchFile(t);yield o.FsUtil.createFile(e),yield o.FsUtil.writeFile(e,r)}))}static sha256(t){const e=l.createHash("sha256");return e.update(t),e.digest("hex")}static contactUrl(t,e){return t.endsWith("/")?t.concat(e):t.concat("/").concat(e)}static getErrorThrowLocation(t){const e=t.stack.substring(0,t.stack.indexOf("\n"));return e.substring(e.lastIndexOf(s.default.sep)+1,e.length)}static getServerAddress(){let t=u.config.store.config.server;if(!t){const e=u.config.listen;t=`${e.proto}://${"0.0.0.0"===e.host?m.getLocalIPv4Address():e.host}:${e.port}`}return t}static formatDateTime(t){const e=new Date(t);return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDay()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`}static getHostName(){return d.default.hostname()}static compatibleKeyword(t){return t?"string"==typeof t?t.split(","):t:[]}static getLocalIPv4Address(){const t=d.default.networkInterfaces();for(const e in t){const r=t[e];for(const t of r)if("IPv4"===t.family&&!t.internal)return t.address}return"localhost"}static hspDetect(t){return i(this,void 0,void 0,(function*(){const e=[],r=yield o.FsUtil.readFile(t);if(h.default.list({onentry:t=>{(t.path.endsWith(".hsp")||t.path.endsWith(".har"))&&e.push(t.path)}}).end(r),2!==e.length)return null;const i={interfaceHar:"",hsp:""};return e.forEach((t=>{t.endsWith(".har")?i.interfaceHar=t:t.endsWith(".hsp")&&(i.hsp=t)})),i.interfaceHar&&i.hsp?i:null}))}static validHspDetectResult(t){if(!t)throw new p.RepoClientError(g.ErrorCode.PackagContentError,"Invalid tgz file, it's must both contain '.har' file and '.hsp' file!")}static getFilePathFromPkg(t,e){return i(this,void 0,void 0,(function*(){const r=yield o.FsUtil.readFile(t),i={},n=Array.from(new Set(e.filter((t=>t))));if(!n.length)return i;return h.default.list({onentry:e=>{const r=s.default.join(t,e.path.toLowerCase()),o=n.find((e=>{const i=s.default.join(t,"package",e.toLowerCase());return r===i}));o&&(i[o]=e.path)}}).end(r),i}))}static fsrm(t,e={recursive:!0,force:!0,maxRetries:5}){return i(this,void 0,void 0,(function*(){const{recursive:r,force:i,maxRetries:n}=e;try{yield o.FsUtil.rm(t,{recursive:r,force:i,maxRetries:n})}catch(e){f.OhpmLazyLogger.warn(`fail to delete the path: ${t}, message error: ${null==e?void 0:e.message}`)}}))}static addProperties(t,e){return Object.assign(Object.assign({},t),e)}}exports.CommonUtil=m;