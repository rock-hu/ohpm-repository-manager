"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var r=Object.getOwnPropertyDescriptor(t,a);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,r)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(a){if(a&&a.__esModule)return a;var i={};if(null!=a)for(var r in a)"default"!==r&&Object.prototype.hasOwnProperty.call(a,r)&&e(i,a,r);return t(i,a),i},i=this&&this.__awaiter||function(e,t,a,i){return new(a||(a=Promise))((function(r,n){function c(e){try{s(i.next(e))}catch(e){n(e)}}function o(e){try{s(i.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(c,o)}s((i=i.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.packageController=void 0;const r=a(require("express")),n=require("./SearchParam"),c=require("./PackageService"),o=require("../../packages/definitions/types"),s=require("../../common/CommonValidator"),p=require("../../common/RepoResponse");exports.packageController=new class{constructor(){this.basePath="/api/packages",this.router=r.Router(),this.initRouter()}initRouter(){this.router.get("/search",this.getPackageList),this.router.get("/:id",this.getPackageDetail),this.router.get("/:id/dependency-types/:dependencyType",this.getDepList),this.router.get("/dependent/:id",this.getDependentList)}getPackageList(e,t,a){return i(this,void 0,void 0,(function*(){try{const a=new n.SearchParam(e.query),i=a.getCurrentPage(),r=a.getPageSize(),o=yield c.packageService.getPackageList(a),s=o.total,u={total:s,pageNum:i,pageSize:r,data:o.packageList,pages:Math.ceil(s/r)};p.RepoResponse.success(t,u)}catch(e){a(e)}}))}getPackageDetail(e,t,a){return i(this,void 0,void 0,(function*(){const i=e.params.id;try{s.CommonValidator.checkPackageID(i);const e=yield c.packageService.getPackageDetail(i);p.RepoResponse.success(t,e)}catch(e){a(e)}}))}getDepList(e,t,a){return i(this,void 0,void 0,(function*(){const i=e.params.id;let r=o.DepType.NORMAL;try{s.CommonValidator.checkPackageID(i);const a=e.params.dependencyType;s.CommonValidator.checkDependencyType(a),"devDependencies"===a?r=o.DepType.DEV:"dynamicDependencies"===a&&(r=o.DepType.DYNAMIC);const u=new n.SearchParam(e.query),g=u.getCurrentPage(),d=u.getPageSize(),l=yield c.packageService.getPageDepList(i,g,d,r),h={total:l.total,pageNum:g,pageSize:d,data:l.data,pages:Math.ceil(l.total/d)};p.RepoResponse.success(t,h)}catch(e){a(e)}}))}getDependentList(e,t,a){return i(this,void 0,void 0,(function*(){const i=e.params.id;try{s.CommonValidator.checkPackageID(i);const a=new n.SearchParam(e.query),r=a.getCurrentPage(),o=a.getPageSize(),u=yield c.packageService.getPageDependentList(i,r,o);p.RepoResponse.success(t,{total:u.total,pageNum:a.getCurrentPage(),pageSize:a.getPageSize(),data:u.data,pages:Math.ceil(u.total/o)})}catch(e){a(e)}}))}};