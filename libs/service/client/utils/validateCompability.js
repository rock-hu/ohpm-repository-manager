"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,n)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var i={};if(null!=o)for(var n in o)"default"!==n&&Object.prototype.hasOwnProperty.call(o,n)&&e(i,o,n);return t(i,o),i},i=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,r){function a(e){try{c(i.next(e))}catch(e){r(e)}}function l(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,l)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateCompability=void 0;const r=o(require("tar")),a=n(require("fs-extra")),l=require("../../../packages/log"),c=require("../../../packages/config/config"),s=require("../../../common/RepoError"),u=require("../../../common"),p=["compatibleSdkVersion","compatibleSdkType","obfuscated"],d=["name","compatibleSdkVersion","compatibleSdkType"];function f(e,t){switch(e){case"info":l.OhpmLazyLogger.info("",t);break;case"warn":l.OhpmLazyLogger.warn("",t);break;case"error":throw new s.RepoClientError(u.ErrorCode.CompabilityError,t);default:l.OhpmLazyLogger.debug("","level not match the compability_log_level.")}}exports.validateCompability=function(e,t){return i(this,void 0,void 0,(function*(){l.OhpmLazyLogger.debug("","start validateCompability.");const o=c.config.compability_log_level;if("close"===o)return void l.OhpmLazyLogger.debug("",'the value of "compability_log_level" is "close", ignore validateCompability.');!function(e,t){l.OhpmLazyLogger.debug("",`validateCommonFields, level: ${t}.`),p.forEach((o=>{const i=e[`${o}`];i?"string"==typeof i&&i.length>64&&f("error",`The length of "${o}" field must range [1, 64] in oh-package.json5.`):"boolean"!=typeof i&&f(t,`The "${o}" field is empty or not exist in oh-package.json5.`)}))}(t,o);const n=yield function(e){return i(this,void 0,void 0,(function*(){const t=[];return r.t({onentry(e){if("Directory"!==e.type&&e.path.startsWith("package/libs")&&e.path.endsWith(".so")){const o=e.path.lastIndexOf("/");t.push(e.path.slice(o+1))}}}).end(yield a.default.readFileSync(e)),t}))}(e);n&&n.length&&(yield function(e,t,o){return i(this,void 0,void 0,(function*(){l.OhpmLazyLogger.debug("",`validateNativeComponents, level: ${o}.`),e&&e.length?e.forEach((e=>{for(const i of d){const n=e[`${i}`];n?"name"!==i||t.includes(n)||f(o,`not found the so target in the publish package with name: "${n}" configed in "nativeComponents".`):f(o,`The "${i}" field is empty or not exist in "nativeComponents" node of oh-package.json5.`)}})):f(o,'The "nativeComponents" field is empty or not exist in oh-package.json5.')}))}(t.nativeComponents,n,o)),l.OhpmLazyLogger.debug("","validateCompability completed.")}))};