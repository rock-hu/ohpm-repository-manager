"use strict";var e=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadConfig=void 0;const o=require("../../packages/log"),r=t(require("log4js")),n=require("../../common/DbFactory"),i=require("../../utils/CommonConstants"),a=require("../../entity/PackageManifest"),s=require("../../utils/FsUtil"),c=t(require("path")),l=require("../install"),u=require("../../packages/config/constants"),d=require("../../packages/config/config"),g=require("../../packages/config/checker"),f=require("../../common/RepoError"),p=require("../../common"),h=t(require("url")),y=t(require("node-fetch")),m=require("./common/checkInstallAndSetRoot"),v=require("./common/checkPublicRegistry"),k=require("./common/paramsConcatToUrl"),$=require("./common/getPublicRegistryAgent"),x=require("../../concurrent/ConcurrentExecutor"),w=require("./definitions"),L={pageSize:50,sortedType:"LATEST",maxConcurrent:20,retryTimes:0,retryInterval:1e3};function A(t){return e(this,void 0,void 0,(function*(){const e=yield(0,l.readCongFileFromEnv)(),o=yield(0,l.readFileFromEnv)(u.PathConstants.RUNTIME_PATH);if(!(yield s.FsUtil.exists(o))||0===e.length)throw new f.RepoClientError(p.ErrorCode.NotSupportOperation,`please run \`ohpm-repo start\` before  ${t}`);return yield(0,d.parseAndUpdateGlobalConfig)(e),yield(0,g.checkAndUpdateConfig)(d.config),d.config}))}function E(e){const{filter:t}=e;try{new RegExp(t)}catch(e){return(0,o.consoleError)(`Invalid regex: ${t}`),!1}return!0}function b(t,r,n){return e(this,void 0,void 0,(function*(){t.endsWith("/")&&(t=t.slice(0,-1));const e=`${t}/${r}`;o.OhpmLazyLogger.info(`fetching ${e}.`);const i=yield(0,y.default)(e,{agent:(0,$.getPublicRegistryAgent)(e)});if(!i.ok)return o.OhpmLazyLogger.error(`fetch "${r}" metadata failed, ${i.status}:${i.statusText}, ${e}.`),n.push(r),[];const a=yield i.json(),s=[];return Object.values(a.versions).map((e=>{s.push(e._id)})),s}))}exports.default=function(t){return e(this,void 0,void 0,(function*(){try{const{filter:l,publicRegistry:u}=t;u?yield function(t){return e(this,void 0,void 0,(function*(){const{publicRegistry:r,httpProxy:n,filter:i}=t;if(!E(t))return;w.migrateProxyConfig.httpProxyUrl=n;const a=yield(0,v.checkPublicRegistry)(r),l=h.default.parse(a),u=l.href.slice(0,l.href.length-l.path.length);let d=yield function(t,r){return e(this,void 0,void 0,(function*(){const n=[];let i=0;const a=`${t}/ohpmweb/registry/oh-package/openapi/v1/search`,s={condition:"",pageNum:1,pageSize:L.pageSize,sortedType:L.sortedType,isHomePage:!1},c=(0,k.paramsConcatToUrl)(a,s);o.OhpmLazyLogger.info(`fetching ${c}.`);const l=yield(0,y.default)(c,{agent:(0,$.getPublicRegistryAgent)(c)});if(!l.ok)throw new Error(`fetch package list failed, ${c}.`);const u=yield l.json();u.body.rows.map((e=>{n.push(e.name)})),i=u.body.total;for(let e=2;e<=i/L.pageSize+1;e++){++s.pageNum;const e=(0,k.paramsConcatToUrl)(a,s);o.OhpmLazyLogger.info(`fetching ${e}.`);const t=yield(0,y.default)(e,{agent:(0,$.getPublicRegistryAgent)(e)});if(!t.ok){throw new Error(`fetch package list failed, you need to set a proxy or check public-registry, ${e}.`)}(yield t.json()).body.rows.map((e=>{n.push(e.name)}))}const d=[];return yield function(t,r,n){return e(this,void 0,void 0,(function*(){const i=[],a=x.ConcurrentExecutor.creatInstance();for(let o=0;o<r.length;o++)a.addAsyncTask((()=>e(this,void 0,void 0,(function*(){return b(t,r[o],i).then((e=>{n.push(...e)}))}))));const{maxConcurrent:s,retryInterval:c,retryTimes:l}=L;yield a.runWithErrorHandle(s,l,c),i.length&&o.OhpmLazyLogger.warn(`${i.length} package${i.length>1?"s":""} failed to fetch metadata.`)}))}(r,n,d),d}))}(u,l.href);d=i?yield function(t,o){return e(this,void 0,void 0,(function*(){const{filter:e}=o,r=new RegExp(e);return t.filter((e=>r.test(e)))}))}(d,t):d,d.sort();const g=c.default.normalize(c.default.posix.join(process.cwd(),`pkgInfo_${Date.now()}.json`)),f={packageNameArray:d};yield s.FsUtil.writeFile(g,JSON.stringify(f,null,2)),i?o.OhpmLazyLogger.info(`Export matched ${d.length} packages names success:`,`save to "${g}".`):o.OhpmLazyLogger.info(`Export ${d.length} packages names success:`,`save to "${g}".`)}))}(t):l?(yield(0,m.checkInstallAndSetRoot)(),yield function(t){return e(this,void 0,void 0,(function*(){const{filter:e}=t;if(!E(t))return;const r=new RegExp(e),l=yield A("export pkgInfo");yield(0,n.initDB)(l.db);const u=(yield n.commonDB.findByFilter(a.OHPM_PACKAGE_MANIFEST_DB_NAME,{filter:{status:i.PackageStatus.Published}})).recordList.filter((e=>r.test(`${e.name}@${e.version}`))).map((e=>`${e.name}@${e.version}`));if(0===u.length)return void o.OhpmLazyLogger.warn("no matched packages found in the database");const d={packageNameArray:u},g=c.default.normalize(c.default.posix.join(process.cwd(),`pkgInfo_${Date.now()}.json`));yield s.FsUtil.writeFile(g,JSON.stringify(d,null,2)),o.OhpmLazyLogger.info("export matched packages success:",`total ${d.packageNameArray.length} packages, save to "${g}".`)}))}(t)):(yield(0,m.checkInstallAndSetRoot)(),yield function(){return e(this,void 0,void 0,(function*(){const e=yield A("export pkgInfo");yield(0,n.initDB)(e.db);const t=yield n.commonDB.findByFilter(a.OHPM_PACKAGE_MANIFEST_DB_NAME,{filter:{status:i.PackageStatus.Published}}),r={packageNameArray:[]};if(!t.recordList.length)return void o.OhpmLazyLogger.warn("no packages found in the database");r.packageNameArray=t.recordList.map((e=>`${e.name}@${e.version}`)).sort();const l=c.default.normalize(c.default.posix.join(process.cwd(),`pkgInfo_${Date.now()}.json`));yield s.FsUtil.writeFile(l,JSON.stringify(r,null,2)),o.OhpmLazyLogger.info("export all package names success:",`total ${t.total} packages, save to "${l}".`)}))}())}catch(e){(0,o.consoleError)(`fail to export the list of all packages: ${e.message}`)}finally{r.default.shutdown((()=>process.exit(1)))}}))},exports.loadConfig=A;