"use strict";var e=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,s){function i(e){try{l(n.next(e))}catch(e){s(e)}}function g(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,g)}l((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.format=exports.consoleError=exports.consoleInfo=exports.printLogBoldYellow=exports.initLogger=exports.OhpmLazyLogger=void 0;const o=t(require("log4js")),n=require("../../common/Constants"),r=t(require("path")),s=require("../../utils/FsUtil"),i=require("../config/config"),g=require("../../tools/posh"),l=require("../config/constants");class c{constructor(){this.type="dateFile",this.isLogStdout=!1}static getInstance(){return this.Instance||(this.Instance=new c,this.Instance.initLog(n.Constants.LOG_PATH)),this.Instance}initLog(e){this.initLogConfig(e)}static getNewHotLogFileNames(){const e=[],t=this.HotLogFileNames;for(let o=0;o<t.length;o++)e[o]=`${n.Constants.MACHINE_CODE}_${t[o]}`;return e}initLogConfig(e){this.initType(e);const t=i.config&&l.ConfigItemValue.LOG_LEVEL.includes(i.config.loglevel_run)?i.config.loglevel_run:l.ConfigItemValue.DEFAULT_LOGLEVEL,r=i.config&&l.ConfigItemValue.LOG_LEVEL.includes(i.config.loglevel_operate)?i.config.loglevel_operate:l.ConfigItemValue.DEFAULT_LOGLEVEL,s=i.config&&l.ConfigItemValue.LOG_LEVEL.includes(i.config.loglevel_access)?i.config.loglevel_access:l.ConfigItemValue.DEFAULT_LOGLEVEL,g=i.config&&l.ConfigItemValue.LOG_LEVEL.includes(i.config.loglevel_run)?i.config.loglevel_run:l.ConfigItemValue.DEFAULT_LOGLEVEL,c={replaceConsole:!0,appenders:{console:{type:"stdout",layout:{type:"colored"}},runLog:{type:`${this.type}`,filename:`${e}/${n.Constants.MACHINE_CODE}_run.log`,pattern:"yyyy-MM-dd",encoding:"utf-8",compress:!1,alwaysIncludePattern:!1,keepFileExt:!0,mode:416,numBackups:30,maxLogSize:10485760},file:{type:`${this.type}`,filename:`${e}/${n.Constants.MACHINE_CODE}_run.log`,pattern:"yyyy-MM-dd",alwaysIncludePattern:!1,keepFileExt:!0,mode:416,numBackups:30},operateLog:{type:`${this.type}`,filename:`${e}/${n.Constants.MACHINE_CODE}_operate.log`,pattern:"yyyy-MM-dd",keepFileExt:!0,mode:416,numBackups:180,maxLogSize:10485760},accessLog:{type:`${this.type}`,filename:`${e}/${n.Constants.MACHINE_CODE}_access.log`,pattern:"yyyy-MM-dd",keepFileExt:!0,mode:416,numBackups:180,maxLogSize:10485760},repoErrorLog:{type:`${this.type}`,filename:`${e}/${n.Constants.MACHINE_CODE}_repoError.log`,pattern:"yyyy-MM-dd",keepFileExt:!0,mode:416,numBackups:180,maxLogSize:10485760}},categories:{default:{appenders:this.isLogStdout?["console"]:["console","runLog"],level:t},operate:{appenders:["operateLog"],level:r},access:{appenders:["accessLog"],level:s},repoError:{appenders:this.isLogStdout?["console"]:["console","runLog","repoErrorLog"],level:g},file:{appenders:["file"],level:t},console:{appenders:["console"],level:"all"}}};o.default.configure(c)}getLoggerToFile(){return this.fileLog||(this.fileLog=o.default.getLogger("file")),this.fileLog}static fileInfo(e,...t){c.getInstance().getLoggerToFile().info(e,...t)}static fileError(e,...t){c.getInstance().getLoggerToFile().error(e,...t)}getLoggerToConsole(){return this.consoleLog||(this.consoleLog=o.default.getLogger("console")),this.consoleLog}static consoleInfo(e,...t){c.getInstance().getLoggerToConsole().info(e,...t)}static consoleError(e,...t){c.getInstance().getLoggerToConsole().error(e,...t)}getLogger(){return this.log||(this.log=o.default.getLogger("default")),this.log}static trace(e,...t){c.getInstance().getLogger().trace(e,...t)}static debug(e,...t){c.getInstance().getLogger().debug(e,...t)}static info(e,...t){c.getInstance().getLogger().info(e,...t)}static warn(e,...t){c.getInstance().getLogger().warn(e,...t)}static error(e,...t){c.getInstance().getRepoErrorLogger().error(e,...t)}static getAccessLogger(){const e=c.getInstance();return e.accessLog||(e.accessLog=o.default.getLogger("access")),e.accessLog}getOperateLogger(){return this.operateLogger||(this.operateLogger=o.default.getLogger("operate")),this.operateLogger}getRepoErrorLogger(){return this.repoErrorLogger||(this.repoErrorLogger=o.default.getLogger("repoError")),this.repoErrorLogger}static operateSuccess(e,t,o){const n=c.getInstance().getOperateLogger(),r={userId:o||e.ctx.userId||"-",ip:e.ctx.clientIp||"-",event:t,result:"Success"},s=JSON.stringify(r);return n.info(s),s}static operateFailure(e,t,o){const n=c.getInstance().getOperateLogger(),r={userId:o||e.ctx.userId||"-",ip:e.ctx.clientIp||"-",event:t,result:"Failure"};n.info(JSON.stringify(r))}initType(e){""===e&&(this.isLogStdout=!0,this.type="stdout")}}function a(e){c.consoleInfo(e),0!==n.Constants.LOG_PATH.length&&c.fileInfo(e)}exports.OhpmLazyLogger=c,c.HotLogFileNames=["access.log","run.log","operate.log","repoError.log"],exports.initLogger=function(){return e(this,void 0,void 0,(function*(){yield function(){return e(this,void 0,void 0,(function*(){const e=n.Constants.LOG_PATH;(yield s.FsUtil.exists(e))&&(yield s.FsUtil.chmod(e,n.Constants.PERMISSIONS750))}))}(),yield function(){return e(this,void 0,void 0,(function*(){setInterval((()=>e(this,void 0,void 0,(function*(){const e=n.Constants.LOG_PATH;(yield s.FsUtil.exists(e))&&(yield s.FsUtil.readdir(e)).filter((e=>!c.getNewHotLogFileNames().includes(e))).forEach((t=>{const o=r.default.join(e,t);s.FsUtil.chmod(o,n.Constants.PERMISSIONS400)}))}))),36e5)}))}()}))},exports.printLogBoldYellow=function(e){a(g.posh.bold.yellow(e))},exports.consoleInfo=a,exports.consoleError=function(e){c.consoleError(e),0!==n.Constants.LOG_PATH.length&&c.fileError(e)},exports.format=function(e,t){return t?e.replace(/{{([^}]+)}}/g,((e,o)=>t[o]||e)):e};