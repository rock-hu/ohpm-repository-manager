"use strict";var e=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CustomStorage=void 0;const o=require("../../../packages/log"),n=t(require("path")),r=require("../../../service/deployedInstance/DeployedInstanceService"),i=require("../../../common/Constants"),s=require("../../../utils/CommonUtil"),a=require("../../../packages/config/config"),c=require("../../../packages/config/constants"),d=t(require("stream")),l=require("../../../common/RepoError"),u=require("../../../common");class h{constructor(e){this.storage=e}init(){return e(this,void 0,void 0,(function*(){yield this.storage.init(),yield this.customStorageInit(),o.OhpmLazyLogger.info("customStorage: initialize successfully.")}))}save(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.storage.save(t,r);return o.OhpmLazyLogger.info(`customStorage: save file ${r.packageName}${r.version?"-"+r.version:""}\`s ${n.default.basename(t)} successfully.`),e}))}delete(t){return e(this,void 0,void 0,(function*(){const e=yield this.storage.delete(t);return e?o.OhpmLazyLogger.info(`customStorage: delete file(saveResponse: ${t}) successfully.`):o.OhpmLazyLogger.warn(`customStorage: fail to delete file(saveResponse: ${t}).`),e}))}download(t){return e(this,void 0,void 0,(function*(){try{return this.storage.download(t)}catch(e){throw new l.RepoClientError(u.ErrorCode.downloadDataFail,`fail to download data, it's a serious problem, please check whether data exists in the file storage center, data id is "${t}"`,e)}}))}downloadStream(t){return e(this,void 0,void 0,(function*(){let e;try{const o=yield this.storage.download(t);e=new d.default.PassThrough,e.end(o);const n=t=>{throw e.destroy(t),e.removeListener("error",n),t};return e.once("error",n),e}catch(t){throw null==e||e.destroy(t),t}}))}getDownloadUrl(t){return e(this,void 0,void 0,(function*(){return this.storage.getDownloadUrl(t)}))}customStorageInit(){return e(this,void 0,void 0,(function*(){const e=yield r.deployedInstanceService.getDeployedInstanceList(),t=s.CommonUtil.getHostName(),o=a.config.listen.port.toString(),n=i.Constants.VERSION,d=yield(0,a.readCryptoVersion)(c.PathConstants.CRYPTO_VERSION_PATH),l=yield(0,a.readCryptoVersion)(c.PathConstants.NEW_CRYPTO_VERSION_PATH);h.hasMachine(e,t)||(yield r.deployedInstanceService.addDeployedInstance(t,o,n,d,l))}))}static removeInstance(){return e(this,void 0,void 0,(function*(){const e=yield r.deployedInstanceService.getDeployedInstanceList(),t=s.CommonUtil.getHostName();h.hasMachine(e,t)&&(yield r.deployedInstanceService.removeDeployedInstance("machine",t))}))}static hasMachine(e,t){let o=!1;for(let n=0;n<e.total;n++)if(e.recordList[n].machine===t){o=!0;break}return o}}exports.CustomStorage=h;