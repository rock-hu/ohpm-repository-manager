"use strict";var e=this&&this.__awaiter||function(e,r,i,t){return new(i||(i=Promise))((function(o,a){function n(e){try{c(t.next(e))}catch(e){a(e)}}function s(e){try{c(t.throw(e))}catch(e){a(e)}}function c(e){var r;e.done?o(e.value):(r=e.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,s)}c((t=t.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GROUP_TABLE=void 0;const i=require("../../packages/log"),t=r(require("log4js")),o=require("../../utils/FsUtil"),a=r(require("path")),n=require("./exportPkgInfoCmd"),s=require("../../common/DbFactory"),c=require("../../service/repo/FileInfo"),u=require("../../service/repo/RepoService"),l=require("../../service/client/login/OhUserInfo"),p=require("../../service/repo/UploadPackageVO"),d=r(require("compressing")),g=require("./type"),f=require("../../packages/config/config"),h=require("./common/checkInstallAndSetRoot"),y=require("./common/checkAuthPluginUserId"),m=require("../../service/group/GroupService"),k=require("../../common/Constants"),v=require("./common/parsePackageFileStr"),w=require("../../entity/DistTags"),$=require("../../service/client/dist-tags/DistTagsRepository"),b=require("../../common/DbAndStoreType"),L=require("../../tools/posh"),I=require("../../entity/GroupMember"),A=require("../../service/repo/RepoRepository"),F=require("../../service/package/PackageRepository"),O=require("../../service/user/UserRepository"),_=require("../../service/group/GroupMemberRepository"),q=require("../../packages/definitions/types"),D=require("./batchDownload/batchDownloadCmd"),U=require("../../utils/RandomUtil");exports.GROUP_TABLE="group";const P={unzipDirTempPath:""};function z(e){if(e.hasOwnProperty("packageName")||!e.hasOwnProperty("packageFile"))return;const{packageFile:r}=e;let i=r;(r.endsWith(".har")||r.endsWith(".tgz"))&&(i=i.slice(0,-4)),i.replace("+","/"),e.packageName=i}function E(r,t){return e(this,void 0,void 0,(function*(){const e=$.DistTagsRepository.getInstance(),{distTags:o,packageName:a}=r,n=(0,v.parsePackageFileStr)(a);if(!o||!o.length)return;i.OhpmLazyLogger.info(`> start to add tags for package: "${a}"`);const c=yield F.packageRepository.findByFilter(n);if(!c.recordList.length)return void i.OhpmLazyLogger.error(`The "${a}" package does not exist. The ${JSON.stringify(o)} tag(s) cannot be add.`);const u=c.recordList[0].authorId;for(const r of o){if((yield s.commonDB.findByFilter(w.DIST_TAGS_DB_NAME,{filter:{packageName:n.name,version:n.version,tag:r}})).recordList.length){i.OhpmLazyLogger.warn(`The "${r}" tag of the "${a}" package already exists.`);continue}const o=new w.DistTags(t,n.name,n.version,r,u);yield e.insert(o),i.OhpmLazyLogger.info(`"${r}" tag added to the ${a} package successfully.`)}}))}function R(r,t,n,s){return e(this,void 0,void 0,(function*(){const{userId:e,user:d,packageName:g,packageFile:h}=r;i.OhpmLazyLogger.info(`> start publish package: "${g}"`);try{const r=a.default.join(t,h),s=yield o.FsUtil.stat(r),y=a.default.join(k.Constants.DATA_DIR,"temp","batch_publish"),m=a.default.join(y,`${U.RandomUtil.generateSecureRandomString(4)}${h}`),v=a.default.join(y,`${U.RandomUtil.generateSecureRandomString(4)}${h}`);yield o.FsUtil.copyFile(r,m),yield o.FsUtil.copyFile(r,v);const w={mimetype:h.endsWith(".har")?"application/octet-stream":"application/x-compressed",path:m,size:s.size,originalname:h},$=yield u.repoService.analyzePackage(n,new c.FileInfo(w));let b;if(e&&f.config.auth_plugin)b=new l.OhUserInfo({id:e,name:d,isAuthPlugin:!0});else{const e=yield O.userRepository.findUserByName(d);b=new l.OhUserInfo({id:e.recordList[0].id,name:d,isAuthPlugin:!1})}w.path=v;const L={repoId:n,fileInfo:new c.FileInfo(w),user:b,uploadPackageInfo:new p.UploadPackageVO($)};yield u.repoService.uploadPackage(L),i.OhpmLazyLogger.info(`publish package success: ${g}`)}catch(e){const r=`fail to publish "${g}": ${e.message}`;throw e.message.includes("version already exists")&&s.push(g),new Error(r)}}))}function j(r){return e(this,void 0,void 0,(function*(){if("object"!=typeof r)throw new Error(`Item in the packageArray array of pkgInfo.json not an object, value:"${JSON.stringify(r)}"`);if(!r.hasOwnProperty("packageFile"))throw new Error(`Item in the packageArray array of pkgInfo.json not have a required "packageFile" field, value:"${JSON.stringify(r)}"`);if(!r.hasOwnProperty("user"))throw new Error(`Item in the packageArray array of pkgInfo.json not have a required "user" field, value:"${JSON.stringify(r)}"`);if(!r.hasOwnProperty("group"))throw new Error(`Item in the packageArray array of pkgInfo.json not have a required "group" field, value:"${JSON.stringify(r)}"`);if("string"!=typeof r.packageFile)throw new Error(`the "packageFile" value type in the packageArray array of pkgInfo.json is incorrect, value:"${JSON.stringify(r)}"`);if("string"!=typeof r.user)throw new Error(`the "user" value type in the packageArray array of pkgInfo.json is incorrect, value:"${JSON.stringify(r)}"`);if("string"!=typeof r.group)throw new Error(`the "group" value type in the packageArray array of pkgInfo.json is incorrect, value:"${JSON.stringify(r)}"`);if(r.hasOwnProperty("userId")&&"string"!=typeof r.userId)throw new Error(`the "userId" value type in the packageArray array of pkgInfo.json is incorrect, value:"${JSON.stringify(r)}"`)}))}function S(r,t=!1){return e(this,void 0,void 0,(function*(){const{user:o,userId:a,group:n,packageName:c}=r;if(!n)return;if(a)return;const u=yield _.groupMemberRepository.findByFilter({group_name:n,role:q.RoleType.Admin});if(u.recordList.length){if(!a&&o)return void(yield function(r,i,t){return e(this,void 0,void 0,(function*(){if(0===(yield _.groupMemberRepository.findByFilter({member_name:r,group_name:i})).recordList.length)throw new Error(`The "${r}" user is specified for the "${t.packageName}" package, but the user is not a "${t.group}" group member.`)}))}(o,n,r));if(!a&&!o&&t){const e=u.recordList[0].member_name;return i.OhpmLazyLogger.warn(`the "${c}" package group has been created, specified publish user is "${e}".`),void(r.user=e)}}if(!u.recordList.length){if(!t)throw new Error(`The "${c}" package's "${n}" group are not created.`);if(o&&t){const e=yield O.userRepository.findUserByName(o);return void(yield N(e.recordList[0].id,o,n))}a||o||!t||(yield function(r,t,o){return e(this,void 0,void 0,(function*(){const e=yield s.commonDB.findByFilter(D.USER_TABLE,{filter:{role:D.AdminRole}});if(!e.recordList.length)throw new Error("Create group error, no administrator is found.");const a=e.recordList[0];i.OhpmLazyLogger.warn(`The "${r}" package group is not created, create group "${t}" for administrator "${a.name}".`),yield N(a.id,a.name,t),o.user=a.name}))}(c,n,r))}}))}function N(r,i,t){return e(this,void 0,void 0,(function*(){const e=new I.GroupMember({group_name:t,member_id:r,group_description:t});yield m.groupService.addGroup(r,e)}))}function T(r,i=!1){return e(this,void 0,void 0,(function*(){const{user:e,userId:t,packageName:o}=r;if(!e||t){if(t&&f.config.auth_plugin&&!(yield(0,y.checkAuthPluginUserId)(t)))throw new Error(`Check "${o}" user error, the "${e}" user does not exist, administrators need to manually create users`);if(t&&!f.config.auth_plugin)throw new Error(`User id "${t}" is a "${e}" user of the auth plugin in the "${o}" package, but the auth plugin is not configured.`);if(!e&&!t&&!i)throw new Error(`No user is specified for the "${o}" package, manually modify the pkgInfo.json file.`)}else{if(!(yield O.userRepository.findUserByName(e)).recordList.length)throw new Error(`Check "${o}" user error, the "${e}" user does not exist, administrators need to manually create users`)}}))}function x(r,i){return e(this,void 0,void 0,(function*(){if(!(yield o.FsUtil.exists(a.default.join(r,i.packageFile))))throw new Error(`the ${i.packageFile} package file not exist in '${r}'.`)}))}exports.default=function(r,c){return e(this,void 0,void 0,(function*(){try{yield(0,h.checkInstallAndSetRoot)(),k.GlobalState.isBatchPublishCmdNoCheck=!0,yield function(r,t){return e(this,void 0,void 0,(function*(){const c=a.default.resolve(process.cwd(),r),{tempDir:u,unzipDir:l}=yield function(r){return e(this,void 0,void 0,(function*(){if(!(yield o.FsUtil.exists(r)))throw new Error(`"${r}" file does not exist.`);if(!r.endsWith(g.ZIP_TYPE))throw new Error(`"${r}" file is not a zip file.`);const e=a.default.join(k.Constants.DATA_DIR,"temp","batch_publish");yield o.FsUtil.createDirIfNotExists(e);const i=a.default.join(e,`batch_publish_${Date.now()}`);yield d.default.zip.uncompress(r,i);const t=yield o.FsUtil.readdir(i);let n=i;if(1===t.length){const e=a.default.posix.join(n,t[0]);n=(yield o.FsUtil.stat(e)).isDirectory()?e:i}return{unzipDir:n,tempDir:i}}))}(c);P.unzipDirTempPath=u,yield function(r){return e(this,void 0,void 0,(function*(){if(!(yield o.FsUtil.exists(a.default.join(r,"pkgInfo.json"))))throw new Error('"pkgInfo.json" file does not exist in the .zip file')}))}(l);const p=JSON.parse(yield o.FsUtil.readFile(a.default.join(l,"pkgInfo.json"),"utf-8"));if(!p.packageArray||!Array.isArray(p.packageArray))throw new Error('the "packageArray" array is missing in the pkgInfo.json file');const h=yield(0,n.loadConfig)("batch publish");yield(0,s.initDB)(h.db);const y=yield A.repoRepository.getList(),m=[],v=[],w=[];for(let e=0;e<p.packageArray.length;e++){p.packageArray[e].packageName||z(p.packageArray[e]);const{packageName:r}=p.packageArray[e];try{yield j(p.packageArray[e]),yield x(l,p.packageArray[e]),yield T(p.packageArray[e],t.force),yield S(p.packageArray[e],t.force),yield R(p.packageArray[e],l,y.recordList[0].id,m),yield E(p.packageArray[e],y.recordList[0].name)}catch(e){i.OhpmLazyLogger.error(e.message),w.push(e.message),v.push(r)}}yield function(r,t,n,s){return e(this,void 0,void 0,(function*(){if(r.length){const e=n-r.length;i.OhpmLazyLogger.info(`${e} package(s) publish successfully.`),i.OhpmLazyLogger.error(`${r.length} package(s) publish unsuccessfully.`),t.length&&i.OhpmLazyLogger.error(`there are ${t.length} failure${t.length>1?"s":""} because the package version already exists.`);const c=a.default.join(process.cwd(),`batch_publish_error_${Date.now()}.txt`);let u="";for(let e=0;e<s.length;e++)u+=`${s[e]}\n`;yield o.FsUtil.writeFile(c,u),i.OhpmLazyLogger.error(`view all the error in "${c}".`)}else i.OhpmLazyLogger.info(`all ${n} package(s) are successfully published`)}))}(v,m,p.packageArray.length,w),f.config.db.type===b.DbType.FileDb&&i.OhpmLazyLogger.warn(L.posh.bold.yellow('You are using "filedb" to store data. If you have already started a repository service, please run `ohpm-repo restart` to restart the service.'))}))}(r,c)}catch(e){(0,i.consoleError)(`batch publish fail: ${e.message}.`)}finally{P.unzipDirTempPath&&(yield o.FsUtil.exists(P.unzipDirTempPath))&&(yield o.FsUtil.rm(P.unzipDirTempPath,{recursive:!0,force:!0})),t.default.shutdown((()=>process.exit(1)))}}))};