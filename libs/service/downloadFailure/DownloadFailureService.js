"use strict";var e=this&&this.__awaiter||function(e,o,r,t){return new(r||(r=Promise))((function(i,n){function a(e){try{d(t.next(e))}catch(e){n(e)}}function u(e){try{d(t.throw(e))}catch(e){n(e)}}function d(e){var o;e.done?i(e.value):(o=e.value,o instanceof r?o:new r((function(e){e(o)}))).then(a,u)}d((t=t.apply(e,o||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.downloadFailureService=void 0;const o=require("../../packages/definitions/types"),r=require("../../utils/PageUtil"),t=require("../../entity/DownloadFailure"),i=require("./DownloadFailureRepository"),n=require("../package/PackageRepository"),a=require("../../common/RepoError"),u=require("../../common"),d=require("../../utils/CommonUtil"),s=require("../../entity/PackageMetaData"),l=require("../../common/DbFactory");exports.downloadFailureService=new class{addDownloadFailure(r,c,p,m,w,h,y){return e(this,void 0,void 0,(function*(){if(!r||!c)return;let e="";if(p)e=d.CommonUtil.sha256(`${r}:${c}:${p}`);else{const o=d.CommonUtil.sha256(`${r}:${c}`),t=yield l.commonDB.findById(s.OHPM_PACKAGE_METADATA_DB_NAME,o);t&&(e=d.CommonUtil.sha256(`${r}:${c}:${t.latestVersion}`))}if(!e)return;const f=yield n.packageRepository.getManifestById(e);if(!f)throw new a.RepoClientError(u.ErrorCode.PackageNotExist,"The package does not exist!");{const r=new t.DownloadFailure({packageId:e,downloadHost:m,downloadPort:w,downloadPath:h,failureReason:y,handled:o.HandledType.UnProcess,repoName:f.repoName,name:f.name,version:f.version,checksum:f.checksum,groupName:f.groupName});yield i.downloadFailureRepository.insert(r)}}))}updateDownloadFailure(o){return e(this,void 0,void 0,(function*(){return i.downloadFailureRepository.update(o)}))}getCheckPackage(o=1,t=r.MAX_PAGE_SIZE,n){return e(this,void 0,void 0,(function*(){return i.downloadFailureRepository.getCheckPackage(o,t,n)}))}};