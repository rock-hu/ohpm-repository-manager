"use strict";var e=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,a){function r(e){try{l(i.next(e))}catch(e){a(e)}}function s(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(r,s)}l((i=i.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.InstallService=void 0;const t=require("../../../common/DbFactory"),o=require("../../../entity/PackageMetaData"),i=require("../../../common/FSFactory"),n=require("../../../utils/CommonUtil"),a=require("../../../utils/CommonConstants"),r=require("../../../tools/json5"),s=require("../../../common/RepoError"),l=require("../../../common"),d=require("../../../entity/DownloadPackage"),c=require("./installRepository"),u=require("../../package/PackageRepository");class _{static getInstance(){if(!this.Instance){const e=c.InstallRepository.getInstance();this.Instance=new _(e)}return this.Instance}constructor(e){this.installRepository=e}searchMetaByPackageName(s,l,d){return e(this,void 0,void 0,(function*(){const e=yield t.commonDB.findById(o.OHPM_PACKAGE_METADATA_DB_NAME,n.CommonUtil.sha256(`${s}:${l}`));if(!e)return;const c=yield i.FsFactory.getInstance(),u=(yield c.download(e.metaJsonFileId)).toString(),_=r.JSON5.parse(u);return Object.values(_.versions).forEach((e=>{const t=e.dist.tarball;if(e.dist.tarball=t.replace(a.DOWNLOAD_DOMAIN,d),e.dist.resolved_hsp){const t=e.dist.resolved_hsp;e.dist.resolved_hsp=t.replace(a.DOWNLOAD_DOMAIN,d)}})),_}))}increaseDownloads(t){return e(this,void 0,void 0,(function*(){const{repoName:e,name:o,fileName:i,group:a}=t;try{const i=t.getVersion(),r=a?`${a}/${o}`:o,s=this.getCurTimeOfDayMillis(),l=n.CommonUtil.sha256(`${e}:${r}:${i}:${s}`),c=yield this.installRepository.findById(l);if(c)c.downloadNumber++,yield this.installRepository.updateById(c);else{const t=new d.DownloadPackage({id:l,repoName:e,name:r,version:i,downloadDay:s,downloadNumber:1});yield this.installRepository.insert(t)}}catch(t){throw new s.RepoClientError(l.ErrorCode.SaveDownloadPackageInfoError,`fail to increase downloadPackage info! repoName: ${e}, packageName: ${i}, group: ${a}`,t)}}))}fetchLatestWeekDownloadDataForPackage(t,o){return e(this,void 0,void 0,(function*(){try{const e=this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_WEEK,i=this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_DAY,n=yield this.installRepository.findDownloadPackageInfoByNameAndTime(t,o,{startTime:e,endTime:i}),r=yield u.packageRepository.getVersionListByName(t,o);return this.getLatestWeekDownloadList(r,n)}catch(e){throw new s.RepoClientError(l.ErrorCode.FetchLatestWeekDownloadDataForPackageError,"fail to fetch latest week download package data!",e)}}))}fetchAnnualWeeklyDownloadsForPackage(t,o){return e(this,void 0,void 0,(function*(){try{const e=this.getCurTimeOfDayMillis()-a.NUMBER_OF_WEEK_IN_YEAR*a.NUMBER_OF_MILLIS_IN_WEEK,i=this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_DAY,n=yield this.installRepository.findDownloadPackageInfoByNameAndTime(t,o,{startTime:e,endTime:i});return this.getAnnualWeeklyDownloadList(n)}catch(e){throw new s.RepoClientError(l.ErrorCode.FetchAnnualWeeklyDownloadsForPackageError,"fail to fetch latest annual weekly download package data!",e)}}))}deleteExpiredDownloadPackageInfo(t,o){return e(this,void 0,void 0,(function*(){yield this.installRepository.deleteByRangeTime(t,o)}))}deleteByPackageNameAndVersion(t,o,i){return e(this,void 0,void 0,(function*(){yield this.installRepository.deleteByPackageNameAndVersion(t,o,i)}))}getCurTimeOfDayMillis(){const e=new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime()}getStartTimeByTime(e){const t=Math.floor((this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_DAY-e)/a.NUMBER_OF_MILLIS_IN_WEEK);return this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_WEEK-t*a.NUMBER_OF_MILLIS_IN_WEEK}getLatestWeekDownloadList(e,t){const o=[];for(let i=0;i<e.total;i++){const n=e.recordList[i].version;let a=0;for(const e of t.recordList)e.version===n&&(a+=Number(e.downloadNumber));const r={downloadNum:a,version:n};o.push(r)}return o}getAnnualWeeklyDownloadList(e){const t=new Map;for(let e=0;e<a.NUMBER_OF_WEEK_IN_YEAR;e++){const o=this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_WEEK-e*a.NUMBER_OF_MILLIS_IN_WEEK,i={downloadNum:0,startTime:o,endTime:this.getCurTimeOfDayMillis()-a.NUMBER_OF_MILLIS_IN_DAY-e*a.NUMBER_OF_MILLIS_IN_WEEK};t.set(o,i)}for(const o of e.recordList){const e=this.getStartTimeByTime(o.downloadDay),i=t.get(e);i.downloadNum=Number(o.downloadNumber)+Number(i.downloadNum)}return this.getAnnualWeeklyDownloadListByMap(t)}getAnnualWeeklyDownloadListByMap(e){const t=[];return e.forEach((e=>{t.push(e)})),t}}exports.InstallService=_;