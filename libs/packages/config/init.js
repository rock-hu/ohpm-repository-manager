"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var r={};if(null!=o)for(var i in o)"default"!==i&&Object.prototype.hasOwnProperty.call(o,i)&&e(r,o,i);return t(r,o),r},r=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(i,n){function s(e){try{d(r.next(e))}catch(e){n(e)}}function l(e){try{d(r.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,l)}d((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.modifyYamlFile=exports.encryptYamlSftpPassword=exports.encryptYamlMysqlPassword=exports.initHttpsFiles=exports.judgeReadWriteMode=exports.changeMode=exports.initMode=exports.modeFile=exports.Mode=void 0;const n=i(require("path")),s=require("../../common/Constants"),l=require("../../utils/FsUtil"),d=require("./config"),a=require("../log"),c=o(require("js-yaml")),p=require("../../utils/CryptoUtil"),f=require("../crypto/constants"),u=require("../../common/DbAndStoreType");var y;function h(){return r(this,void 0,void 0,(function*(){if(!(yield g()))return!1;return(yield l.FsUtil.readFile(exports.modeFile)).toString()===y.READWRITE}))}function g(){return r(this,void 0,void 0,(function*(){if(!(yield l.FsUtil.exists(exports.modeFile)))return a.OhpmLazyLogger.warn(`modeFile ${exports.modeFile} not exist.`),!1;const e=(yield l.FsUtil.readFile(exports.modeFile)).toString();return e===y.READONLY||e===y.READWRITE||(a.OhpmLazyLogger.warn(`mode in modeFile ${exports.modeFile} not correct.`),!1)}))}function m(e,t){return r(this,void 0,void 0,(function*(){const o=n.default.resolve(s.Constants.DATA_DIR,e),r=n.default.resolve(s.Constants.DATA_DIR,t);if(o!==r){if(!(yield l.FsUtil.exists(o)))throw a.OhpmLazyLogger.error(`file ${e} does not exist.`),new Error(`file ${e} does not exist`);yield l.FsUtil.copyFile(o,r).catch((t=>{throw a.OhpmLazyLogger.error(`copy file ${e} error:`,t.message),new Error(`copy file ${e} error`)}))}}))}!function(e){e.READONLY="readonly",e.READWRITE="readwrite"}(y=exports.Mode||(exports.Mode={})),exports.modeFile=n.default.join(s.Constants.WORK_DIR,"./runtime/.mode"),exports.initMode=function(){return r(this,void 0,void 0,(function*(){if(yield l.FsUtil.exists(exports.modeFile)){if(!(yield g()))throw a.OhpmLazyLogger.error(`mode in modeFile ${exports.modeFile} not correct.`),new Error(`mode in modeFile ${exports.modeFile} not correct`)}else yield l.FsUtil.createFileIfNotExists(exports.modeFile),yield l.FsUtil.chmod(exports.modeFile,s.Constants.PERMISSIONS640),yield l.FsUtil.writeFile(exports.modeFile,y.READWRITE)}))},exports.changeMode=function(e){return r(this,void 0,void 0,(function*(){const t=yield h();e!==y.READWRITE||t?e===y.READONLY&&t&&(yield l.FsUtil.writeFile(exports.modeFile,y.READONLY)):yield l.FsUtil.writeFile(exports.modeFile,y.READWRITE)}))},exports.judgeReadWriteMode=h,exports.initHttpsFiles=function(){return r(this,void 0,void 0,(function*(){d.config.listen=d.config.listen;try{if(d.config.listen.proto===s.Constants.HTTPS&&d.config.https_key&&d.config.https_cert){const e=d.config.https_key,t=d.config.https_cert,o=n.default.basename(e),r=n.default.basename(t);yield l.FsUtil.createDirIfNotExists(n.default.resolve(s.Constants.DATA_DIR,"./conf")),yield m(e,n.default.resolve(s.Constants.DATA_DIR,"./conf",o)),yield m(t,n.default.resolve(s.Constants.DATA_DIR,"./conf",r)),d.config.https_key=`./conf/${o}`,d.config.https_cert=`./conf/${r}`,(0,d.updateConfig)(d.config),a.OhpmLazyLogger.info("initialize httpsFiles successfully.")}}catch(e){throw a.OhpmLazyLogger.error(`fail to initialize httpsFiles: ${e}`),new Error(`fail to initialize httpsFiles: ${e}`)}}))},exports.encryptYamlMysqlPassword=function(e){return r(this,void 0,void 0,(function*(){try{const t=yield l.FsUtil.readFile(e,"utf8"),o=c.load(t),r=o.db.config.password;r.toString().startsWith(f.KEY_HEAD)||(o.db.config.password=p.CryptoUtil.encrypt(`${r}`),d.config.db=o.db,a.OhpmLazyLogger.debug(`encrypt "${u.DbType.Mysql} password" successfully.`))}catch(e){throw a.OhpmLazyLogger.error(`fail to encrypt mysql password: ${e}`),new Error(`fail to encrypt mysql password: ${e}`)}}))},exports.encryptYamlSftpPassword=function(e){return r(this,void 0,void 0,(function*(){try{const t=yield l.FsUtil.readFile(e,"utf8"),o=c.load(t);o.store.config.location.forEach((e=>{const t=e.read_password,o=e.write_password;t.toString().startsWith(f.KEY_HEAD)||(e.read_password=p.CryptoUtil.encrypt(`${t}`)),o.toString().startsWith(f.KEY_HEAD)||(e.write_password=p.CryptoUtil.encrypt(`${o}`))})),a.OhpmLazyLogger.debug(`"${u.StorageType.Sftp} password" encrypted successfully.`),d.config.store=o.store}catch(e){throw a.OhpmLazyLogger.error(`fail to encrypt "${u.StorageType.Sftp} password": ${e}`),new Error(`fail to encrypt "${u.StorageType.Sftp} password": ${e}`)}}))},exports.modifyYamlFile=function(e,t,o){return r(this,void 0,void 0,(function*(){const r=yield l.FsUtil.readFile(e,"utf8"),i=c.load(r);i[t]=o;const n=c.dump(i);yield l.FsUtil.writeFile(e,n,"utf8")}))};