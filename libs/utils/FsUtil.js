"use strict";var e=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function u(e){try{n(i.next(e))}catch(e){o(e)}}function d(e){try{n(i.throw(e))}catch(e){o(e)}}function n(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,d)}n((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FsUtil=exports.isSubdirectory=void 0;const r=t(require("fs")),i=t(require("fs-extra")),a=require("../tools/json5"),o=require("../packages/log"),u=t(require("node-fetch")),d=require("../packages/config/config"),n=t(require("https")),s=t(require("path"));const l=new n.default.Agent({rejectUnauthorized:!1});exports.isSubdirectory=function(e,t){const r=s.default.relative(t,e);return Boolean(r&&!r.startsWith("..")&&!s.default.isAbsolute(r))},exports.FsUtil={createDirIfNotExists:function(t){return e(this,void 0,void 0,(function*(){(yield i.default.exists(t))||(yield i.default.mkdirp(t))}))},createFileIfNotExists:function(t){return e(this,void 0,void 0,(function*(){(yield i.default.exists(t))||(yield i.default.createFile(t))}))},deleteFolderRecursive:function t(a){return e(this,void 0,void 0,(function*(){if(yield i.default.exists(a)){const e=yield r.default.promises.readdir(a);for(const i of e){const e=s.default.join(a,i);(yield r.default.promises.lstat(e).then((e=>e.isDirectory())))?yield t(e):yield r.default.promises.unlink(e)}yield r.default.promises.rmdir(a)}}))},fetchFile:function(t){return e(this,void 0,void 0,(function*(){let e,r;t.startsWith("https://")&&(r=l);try{if(e=yield(0,u.default)(t,{redirect:"manual",timeout:1e3*d.config.fetch_timeout,agent:r}),e.ok)return e.buffer()}catch(e){throw o.OhpmLazyLogger.error(e.message),new Error(`fail to download url: ${t}: ${e.message}`)}const i=e.headers.get("location");if(302===e.status&&i)try{if(e=yield(0,u.default)(i,{timeout:1e3*d.config.fetch_timeout,agent:r}),e.ok)return e.buffer()}catch(e){throw o.OhpmLazyLogger.error(e.message),new Error(`fail to download url: ${t}: ${e.message}`)}throw new Error(`fail to download url: ${t}`)}))},readJSON:function(t,r="utf-8"){return e(this,void 0,void 0,(function*(){try{return i.default.readJSON(t,r)}catch(e){throw o.OhpmLazyLogger.error("",`${e.message} - check ${t} format.`),""}}))},readJSON5:function(t,r=""){return e(this,void 0,void 0,(function*(){try{const e=yield i.default.readFile(t,"utf8");return a.JSON5.parse(e)}catch(e){e.message=`${e.message} - check ${r||t} format.`,o.OhpmLazyLogger.error("",e.message)}}))},createFile:i.default.createFile,writeFile:i.default.writeFile,rm:i.default.rm,readdir:i.default.readdir,exists:i.default.exists,stat:i.default.stat,statSync:r.default.statSync,readFile:i.default.readFile,copyFile:i.default.copyFile,realpath:i.default.realpath,rename:i.default.rename,rmdir:i.default.rmdir,chmod:i.default.chmod,createWriteStream:i.default.createWriteStream,copy:i.default.copy,createReadStream:r.default.createReadStream};