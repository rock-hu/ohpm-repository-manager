"use strict";var e=this&&this.__awaiter||function(e,r,o,n){return new(o||(o=Promise))((function(t,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function d(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(a,d)}c((n=n.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.InstallRepository=void 0;const r=require("../../../common/DbFactory"),o=require("../../../common/RepoError"),n=require("../../../common"),t=require("../../../packages/definitions/types");class i{static getInstance(){return this.Instance||(this.Instance=new i),this.Instance}insert(t){return e(this,void 0,void 0,(function*(){try{return r.commonDB.insertOne(i.TABLE_NAME,t)}catch(e){throw new o.RepoServerError(n.ErrorCode.SaveDownloadPackageInfoError,"Fail to insert downloadPackage!",e)}}))}deleteByRangeTime(t,a){return e(this,void 0,void 0,(function*(){try{return r.commonDB.deleteByRangeKey(i.TABLE_NAME,"downloadDay",t,a)}catch(e){throw new o.RepoServerError(n.ErrorCode.DeleteDownloadPackageInfoError,"fail to delete outdated downloadPackage info!",e)}}))}deleteByPackageNameAndVersion(t,a,d){return e(this,void 0,void 0,(function*(){const e={repoName:t,name:a};d&&(e.version={in:d});const c=d?`${a}, version: ${d}`:`${a}`;try{return r.commonDB.deleteByQueryFilter(i.TABLE_NAME,e,!0)}catch(e){throw new o.RepoServerError(n.ErrorCode.DeleteDownloadPackageInfoError,`fail to delete downloadPackage info, package: ${c}!`,e)}}))}updateById(t){return e(this,void 0,void 0,(function*(){try{return r.commonDB.updateById(i.TABLE_NAME,t.id,t)}catch(e){throw new o.RepoServerError(n.ErrorCode.UpdateDownloadPackageInfoError,"fail to update downloadPackage info",e)}}))}findByFilter(a={},d,c){return e(this,void 0,void 0,(function*(){const e={filter:a,orderBy:{keyList:["downloadDay"],orderList:[t.OrderType.DESC]}};d&&c&&(e.pageQuery={pageNum:d,pageSize:c});try{return r.commonDB.findByFilter(i.TABLE_NAME,e)}catch(e){throw new o.RepoServerError(n.ErrorCode.FindGroupError,"fail to find downloadPackage info!",e)}}))}findDownloadPackageInfoByNameAndTime(a,d,c){return e(this,void 0,void 0,(function*(){const e={filter:{repoName:a,name:d,downloadDay:{gte:c.startTime,lte:c.endTime}},pick:["version","downloadDay","downloadNumber"],orderBy:{keyList:["downloadDay"],orderList:[t.OrderType.DESC]}};try{return r.commonDB.findByFilter(i.TABLE_NAME,e)}catch(e){throw new o.RepoServerError(n.ErrorCode.FindGroupError,"fail to find downloadPackage info!",e)}}))}findById(t){return e(this,void 0,void 0,(function*(){try{return r.commonDB.findById(i.TABLE_NAME,t)}catch(e){throw new o.RepoServerError(n.ErrorCode.FindGroupError,`fail to find group whose id is ${t}!`,e)}}))}}exports.InstallRepository=i,i.TABLE_NAME="download_package";