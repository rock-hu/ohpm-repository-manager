"use strict";var e=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function a(e){try{_(i.next(e))}catch(e){r(e)}}function s(e){try{_(i.throw(e))}catch(e){r(e)}}function _(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}_((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.parseLogLevelAndAssignDefault=exports.parseAllowRemoveDependedPackagesAndAssignDefault=exports.parseListenAddress=exports.parseConfigFileAndAssignDefault=void 0;const n=t(require("js-yaml")),i=require("../log"),o=require("../../utils/FsUtil"),r=require("../../common/Constants"),a=require("./checker"),s=require("./constants"),_=require("../../common/DbAndStoreType"),f=t(require("path")),l=require("./config");function u(e){const t=/^((https?):(\/\/)?)?((([^/:]*)|\[([^[\]]+)\]):?)?(\d*)\/?$/.exec(e);if(!e||!t)throw i.OhpmLazyLogger.error('parse "listen address" error, please refer the examples in the config.yaml file.'),new Error('parse "listen address" from config.yaml error');const n=t[2]||s.ConfigItemDefault.DEFAULT_PROTOCOL;return{proto:n,host:g(t)||s.ConfigItemDefault.DEFAULT_DOMAIN,port:t[8]?parseInt(t[8]):m(e,n)}}function g(e){let t,n=p(e[6]);return n||(t=e[6]),n=p(e[7]),t||n||(t=e[7]),t}function m(e,t){return p(e)?Number(e):t&&t!==s.ConfigItemDefault.DEFAULT_PROTOCOL?s.ConfigItemDefault.DEFAULT_HTTPS_PORT:s.ConfigItemDefault.DEFAULT_PORT}function p(e){return s.ConfigItemValue.REGEX_NUMBER.exec(e)}function E(e,t,n){if(void 0!==e&&e||(e=n),!Number(e))throw new Error(`"${t}" in config file is not number type`);return e}function c(e,t){(0,a.assertExistInYaml)(e,t),(0,a.assertExistInYaml)(e.type,`${t}.type`),(0,a.assertExistInYaml)(e.config,`${t}.config`);const n=e.config,o=t===s.ConfigItemNames.DB?s.PathConstants.DEFAULT_FILE_DB_PATH:s.PathConstants.DEFAULT_FS_PATH;if(e.type===_.StorageType.Fs||e.type===_.DbType.FileDb){if(null===n)throw i.OhpmLazyLogger.error(`"${t}.config.path" in config file  is not exist, please add the "${t}.config.path".`),new Error(`"${t}.config.path" in config file  is not exist, please add the "${t}.config.path"`);n.path&&""!==n.path||(n.path=o)}return e.config=n,e}function h(e,t){return void 0!==e&&e&&0!==e.length?e:t}function I(e,t){if(t===s.ConfigItemNames.UPLINK_CACHE_PATH){if(void 0===e||!e||0===e.length)return e=s.PathConstants.DEFAULT_UPLINK_PATH;if(!String(e))throw new Error(`"${s.ConfigItemNames.UPLINK_CACHE_PATH}" in config file is not string type`)}if(t===s.ConfigItemNames.UPLINK_CACHE_TIME){if(void 0===e||!e)return e=s.ConfigItemValue.DEFAULT_UPLINK_TIME;if(!Number(e))throw new Error(`"${s.ConfigItemNames.UPLINK_CACHE_PATH}" in config file is not number type`)}return e}function A(e,t){const n=e.listen,i=t===s.ConfigItemNames.HTTPS_KEY?e.https_key:e.https_cert;return"https"===n.proto?((0,a.assertExistInYamlNotNull)(i,t),i):""}function L(e){return void 0===e&&(e=s.ConfigItemDefault.DEFAULT_ALLOW_REMOVE_DEPENDED_PACKAGES),e}function T(e,t){return void 0!==t&&s.ConfigItemValue.LOG_LEVEL.includes(t)||(t=s.ConfigItemDefault.DEFAULT_LOG_LEVEL),t}exports.parseConfigFileAndAssignDefault=function(t){return e(this,void 0,void 0,(function*(){if(!(yield o.FsUtil.exists(t)))throw i.OhpmLazyLogger.error(`config file "${t}" not exist.`),new Error("config file does not exist or not reachable");let a;try{a=n.default.load(yield o.FsUtil.readFile(t,"utf8"))}catch(e){throw i.OhpmLazyLogger.error("config file error",e.message),Error(`config file "${t}" error`)}const _=a;try{_.listen=u(_.listen)}catch(e){throw Error(`parse ListenAddress error, config file "${t}"`)}try{_.deploy_root=h(_.deploy_root,r.Constants.DATA_DIR),_.logs_path=h(_.logs_path,s.PathConstants.DEFAULT_LOG_PATH),function(e){e.max_package_size=E(e.max_package_size,s.ConfigItemNames.MAX_PACKAGE_SIZE,s.ConfigItemDefault.DEFAULT_MAX_PACKAGE_SIZE),e.max_extract_size=E(e.max_extract_size,s.ConfigItemNames.MAX_EXTRACT_SIZE,s.ConfigItemDefault.DEFAULT_MAX_EXTRACT_SIZE),e.max_extract_file_num=E(e.max_extract_file_num,s.ConfigItemNames.MAX_EXTRACT_FILE_NUM,s.ConfigItemDefault.DEFAULT_MAX_EXTRACT_FILE_NUM),e.user_rate_limit=E(e.user_rate_limit,s.ConfigItemNames.USER_RATE_LIMIT,s.ConfigItemDefault.DEFAULT_USER_RATE_LIMIT),e.upload_lock_hour=E(e.upload_lock_hour,s.ConfigItemNames.UPLOAD_LOCK_HOUR,s.ConfigItemDefault.DEFAULT_UPLOAD_LOCK_HOUR),e.upload_max_times=E(e.upload_max_times,s.ConfigItemNames.UPLOAD_MAX_TIMES,s.ConfigItemDefault.DEFAULT_UPLOAD_MAX_TIMES),e.fetch_timeout=E(e.fetch_timeout,s.ConfigItemNames.FETCH_TIMEOUT,s.ConfigItemDefault.DEFAULT_FETCH_TIMEOUT),e.api_timeout=E(e.api_timeout,s.ConfigItemNames.API_TIMEOUT,s.ConfigItemDefault.DEFAULT_API_TIMEOUT),e.keep_alive_timeout=E(e.keep_alive_timeout,s.ConfigItemNames.KEEP_ALIVE_TIMEOUT,s.ConfigItemDefault.DEFAULT_KEEP_ALIVE_TIMEOUT),e.operation_log_retention=E(e.operation_log_retention,s.ConfigItemNames.OPERATION_LOG_RETENTION,s.ConfigItemDefault.DEFAULT_OPERATION_LOG_RETENTION)}(_),_.https_key=A(_,s.ConfigItemNames.HTTPS_KEY),_.https_cert=A(_,s.ConfigItemNames.HTTPS_CERT),_.db=c(_.db,s.ConfigItemNames.DB),_.store=c(_.store,s.ConfigItemNames.STORE),_.auth_plugin=yield function(t){return e(this,void 0,void 0,(function*(){if(void 0!==t){if(void 0===t.name||!t.name||0===t.name.length)throw i.OhpmLazyLogger.error('"auth_plugin.name" in config file is not exist, please add the "auth_plugin.name".'),new Error('"auth_plugin.name" in config file is empty, please add the "auth_plugin.name"');if(void 0===t.path||!t.path||0===t.path.length)throw i.OhpmLazyLogger.error('"auth_plugin.path" in config file is empty, please add the "auth_plugin.path".'),new Error('"auth_plugin.path" in config file is not exist, please add the "auth_plugin.path".');const e=f.default.resolve(r.Constants.WORK_DIR,t.path);if(!(yield o.FsUtil.exists(e)))throw new Error(`"auth_plugin.path" file :${e} in config file is not exist, please modify the "auth_plugin.path".`)}return t}))}(_.auth_plugin),_.uplink_cache_path=I(_.uplink_cache_path,s.ConfigItemNames.UPLINK_CACHE_PATH),_.uplink_cache_time=I(_.uplink_cache_time,s.ConfigItemNames.UPLINK_CACHE_TIME),_.loglevel_run=T(s.ConfigItemNames.LOGLEVEL_RUN,_.loglevel_run),_.loglevel_operate=T(s.ConfigItemNames.LOGLEVEL_OPERATE,_.loglevel_operate),_.loglevel_access=T(s.ConfigItemNames.LOGLEVEL_ACCESS,_.loglevel_access),_.allow_remove_depended_packages=L(_.allow_remove_depended_packages),(0,l.updateConfig)(_)}catch(e){throw i.OhpmLazyLogger.error(`parse config file "${t}" error:`,e.message),Error(`parse config file "${t}" error`)}return _}))},exports.parseListenAddress=u,exports.parseAllowRemoveDependedPackagesAndAssignDefault=L,exports.parseLogLevelAndAssignDefault=T;