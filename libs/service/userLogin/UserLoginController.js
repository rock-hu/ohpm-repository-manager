"use strict";var e=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var i=Object.getOwnPropertyDescriptor(r,t);i&&!("get"in i?!r.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,i)}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),r=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),t=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var o={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&e(o,t,i);return r(o,t),o},o=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,s){function n(e){try{u(o.next(e))}catch(e){s(e)}}function c(e){try{u(o.throw(e))}catch(e){s(e)}}function u(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(n,c)}u((o=o.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.userLoginController=void 0;const i=t(require("express")),s=require("../../common"),n=require("../../utils/RandomUtil"),c=require("./UserLoginService"),u=require("../user/UserService"),a=require("../../entity/User"),l=require("../../packages/log"),d=require("../../common/CommonValidator"),g=require("../loginFailure/LoginFailureService"),p=require("../../common/RepoResponse"),h=require("../../packages/config/config"),y=require("../../middle-ware");class f{constructor(){this.basePath="/api/auth",this.router=i.Router(),this.initRouter()}initRouter(){this.router.get("/userinfo",s.SessionUtil.checkUser,s.CsrfToken.validate,this.getUserByUserId),this.router.post("/register",y.decryptPassword,this.register),this.router.post("/login",s.CsrfToken.gen,y.decryptPassword,this.login),this.router.post("/logout",s.SessionUtil.check,s.CsrfToken.validate,this.logout)}getUserByUserId(e,r,t){return o(this,void 0,void 0,(function*(){const o=e.ctx.userId;try{const e=yield u.userService.getPickUserByUserId(o);p.RepoResponse.success(r,e.recordList[0])}catch(e){t(e)}}))}register(e,r,t){return o(this,void 0,void 0,(function*(){const o=e.body,i=e.originalUrl,s=e.ctx.clientIp;try{yield d.CommonValidator.checkApiCount(s,i,f.REGISTRY_LIMIT_COUNT);const t=new a.User(o);yield u.userService.register(t),l.OhpmLazyLogger.operateSuccess(e,"register",t.id),p.RepoResponse.ok(r)}catch(r){l.OhpmLazyLogger.operateFailure(e,"register"),t(r)}}))}login(e,r,t){return o(this,void 0,void 0,(function*(){const o=e.body.name,i=e.body.password,u=e.originalUrl,a=e.ctx.clientIp;let y;try{yield d.CommonValidator.checkApiCount(a,u,f.LOGIN_LIMIT_COUNT),y=yield c.userLoginService.userLogin(o,i),s.SessionUtil.deleteSessionByUserId(y.id);const t=n.RandomUtil.generateRandomSecretKey();yield s.SessionUtil.save(t,y.id,y.needChangePassword),l.OhpmLazyLogger.operateSuccess(e,"login",y.id),r.cookie("sessionId",t,{path:"/",httpOnly:!0,secure:"https"===h.config.listen.proto,sameSite:"strict"}),p.RepoResponse.ok(r)}catch(r){l.OhpmLazyLogger.operateFailure(e,"login"),yield g.loginFailureService.addLoginFailure(r.message),t(r)}}))}logout(e,r,t){return o(this,void 0,void 0,(function*(){try{yield s.SessionUtil.remove(e.ctx.sessionId),l.OhpmLazyLogger.operateSuccess(e,"logout"),r.clearCookie("sessionId"),p.RepoResponse.ok(r)}catch(r){l.OhpmLazyLogger.operateFailure(e,"logout"),t(r)}}))}}f.REGISTRY_LIMIT_COUNT=100,f.LOGIN_LIMIT_COUNT=100,exports.userLoginController=new f;