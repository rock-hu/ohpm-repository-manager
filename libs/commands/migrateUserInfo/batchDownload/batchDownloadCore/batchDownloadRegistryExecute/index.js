"use strict";var e=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,n){function a(e){try{l(o.next(e))}catch(e){n(e)}}function s(e){try{l(o.throw(e))}catch(e){n(e)}}function l(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(a,s)}l((o=o.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.batchDownloadRegistryExecute=exports.batchDownloadRegistryLocalData=void 0;const t=r(require("path")),o=require("../../../../../common/init"),i=require("../../../../../utils/FsUtil"),n=require("../../../common/checkPkgInfoJson"),a=require("../../../common/checkPublicRegistry"),s=require("../../../exportPkgInfoCmd"),l=require("../../../../../packages/log"),c=require("../../../definitions"),d=require("../../batchDownloadCmd"),u=r(require("compressing")),g=require("../../../../../service/client/publish/PublishService"),f=require("../../../../../common/DbFactory"),h=require("../../../common/getManifestDbFilter"),p=require("../../../../../packages/config/config"),y=require("../../../common/checkAuthPluginUserId"),m=require("../../../common/getPublicRegistryAgent"),L=require("./validateAndRestorePackageJson"),k=r(require("node-fetch")),v=require("./packLibraries"),A=r(require("fs")),P=require("./installAllPackages/getAllPackagesTarBall"),b=require("./installAllPackages/downloadTarBall"),w=require("../../../../../concurrent/ConcurrentExecutor"),x=require("../../../../../utils/CommonConstants"),I=require("./installAllPackages/deCompressPkg"),q=require("../../../../../plugins/auth/CustomAuth"),C=require("../../../common/genErrorTxt"),$=require("../../../../../service/group/GroupMemberRepository"),E=require("../../../../../packages/definitions/types"),_=require("../../../../../service/user/UserRepository");function z(r,t,o){return e(this,void 0,void 0,(function*(){const i=r.slice(0,r.lastIndexOf("@")),n=function(e){let r,t;const o=e.slice(e.lastIndexOf("@")+1);e.startsWith(c.CHAR_AT)?(t=e.slice(0,e.lastIndexOf("@")),r=t.split("/")[0]):(r="",t=e.split(c.CHAR_AT)[0]);return{group:r,name:t,version:o}}(r),a=(0,g.getVerifyName)(i),s={packageFile:`${r.replace("/","+")}.har`,packageName:r,user:"",group:n.group.slice(1),userId:"",distTags:[]};yield function(r,t,o,i){return e(this,void 0,void 0,(function*(){const e=r.slice(0,r.lastIndexOf("@")),n=`${o}/${e}`,a=yield(0,k.default)(n,{agent:(0,m.getPublicRegistryAgent)(n)});if(!a.ok)throw new Error(`fetch package metadata failed, ${n}`);const s=(yield a.json())["dist-tags"];for(let e in s)s[e]===t&&"latest"!==e&&i.distTags.push(e)}))}(r,n.version,t,s);const{recordList:u}=yield f.commonDB.findByFilter(d.PACKAGE_MANIFEST_TABLE,{filter:(0,h.getManifestDbFilter)(a,n.version)});if(u&&u.length)return yield F(r,u[0].authorId,s),s;const L=yield f.commonDB.findByFilter(d.PACKAGE_MANIFEST_TABLE,{filter:{verifyName:a}});if(L.recordList&&L.recordList.length){const e=L.recordList[0].authorId;return yield F(r,e,s),s}return n.group?(yield function(r,t){return e(this,void 0,void 0,(function*(){const e=yield $.groupMemberRepository.findByFilter({group_name:r.group,role:E.RoleType.Admin});if(e.recordList.length){if(yield _.userRepository.findUserById(e.recordList[0].member_id))return void(r.user=e.recordList[0].member_name);if(p.config.auth_plugin&&(yield(0,y.checkAuthPluginUserId)(e.recordList[0].member_id)))return r.user=e.recordList[0].member_name,void(r.userId=e.recordList[0].member_id);throw new Error(`Failed to specify the actual user for "${r.packageName}" package, the owner "${e.recordList[0].member_name}" of the "${r.group}" group does not exist.`)}return l.OhpmLazyLogger.warn(`Failed to specify the actual user for "${r.packageName}" package, the "${r.group}" group cannot be found in the repository. Please manually create the group.`),void t.add(r.group)}))}(s,o),s):(yield function(r,t){return e(this,void 0,void 0,(function*(){const e=yield f.commonDB.findByFilter(d.USER_TABLE,{filter:{role:d.AdminRole}});if(!e.recordList.length)throw new Error(`Failed to specify the actual user for "${r}" package, no administrator is found.`);l.OhpmLazyLogger.warn(`The publish user of the "${r}" does not exist, specify "${e.recordList[0].name}" as the new publish user.`),t.user=e.recordList[0].name}))}(r,s),s)}))}function F(r,t,o){return e(this,void 0,void 0,(function*(){const e=yield f.commonDB.findByFilter(d.USER_TABLE,{filter:{id:t}});if(!e.recordList.length){if(p.config.auth_plugin&&(yield(0,y.checkAuthPluginUserId)(t)))return o.user=yield q.CustomAuth.getInstance().getUserInfo(t),void(o.userId=t);throw new Error(`Failed to specify the actual user for "${r}" package, the "${t}" userId cannot be found in the database.`)}o.user=e.recordList[0].name}))}function R(r,o,i,n,a,s,d){return e(this,void 0,void 0,(function*(){try{const e=t.default.join(o,c.PmDir,r.replace("/","+"));l.OhpmLazyLogger.info(`> start convert package: ${r}`),yield(0,L.validateAndRestorePackageJson)(t.default.join(e,x.PACKAGE),r),yield(0,v.packLibraries)(e,r,o);const n=yield z(r,i,s);a.packageArray.push(n)}catch(e){l.OhpmLazyLogger.error(e.message),d.push(e.message),n.push(r)}}))}exports.batchDownloadRegistryLocalData={maxConcurrent:10,retryTimes:0,retryInterval:1e3},exports.batchDownloadRegistryExecute=function(r,g,f,h){return e(this,void 0,void 0,(function*(){const{publicRegistry:p,httpProxy:y,notUseProxy:m}=h;c.migrateProxyConfig.httpProxyUrl=y,m&&(c.migrateProxyConfig.noProxy=decodeURIComponent(m).replace(";",","));const L=yield(0,n.checkPkgInfoJson)(r),k=yield(0,a.checkPublicRegistry)(p);yield(0,s.loadConfig)("batch download"),yield o.MainInit.particalInit(),L.length>1?l.OhpmLazyLogger.info(`Start to fetch the metadata for ${L.length} packages and their dependencies.`):l.OhpmLazyLogger.info(`Start to fetch the metadata for ${L.length} package and its dependencies.`);const v=[],{getTarBallErrors:x,pkgTarBallMap:q}=yield(0,P.getAllPackagesTarBall)(L,k,v),$=yield(0,b.downloadTarBall)(q,g,v);yield(0,I.deCompressPkg)(g,v);const{convertFailedPkg:E,needManuallyCreateGroup:_,needConvertPkgNum:z}=yield function(r,o,n,a){return e(this,void 0,void 0,(function*(){const o=t.default.join(r,c.PmDir);if(!(yield i.FsUtil.exists(o)))throw new Error(`${o} the save packages directory is not found.`);const s=t.default.join(r,c.PACK_DIR);yield i.FsUtil.createDirIfNotExists(s);const l={packageArray:[]},u=yield i.FsUtil.readdir(o),g=[],f=new Set;let h=0;const p=w.ConcurrentExecutor.creatInstance();for(const i of u){if(!A.default.statSync(t.default.join(o,i)).isDirectory())continue;++h;const s=i.replace("+","/");p.addAsyncTask((()=>e(this,void 0,void 0,(function*(){return R(s,r,n,g,l,f,a)}))))}const{maxConcurrent:y,retryInterval:m,retryTimes:L}=exports.batchDownloadRegistryLocalData;return yield p.runWithErrorHandle(y,L,m),yield i.FsUtil.writeFile(t.default.join(s,d.PkgInfoJson),JSON.stringify(l,null,2)),{convertFailedPkg:g,needManuallyCreateGroup:f,needConvertPkgNum:h}}))}(g,0,k,v);!function(e,r){const t=r.size;t&&l.OhpmLazyLogger.info(`A total of ${t} package(s) successfully obtain download url.`);e.length&&(l.OhpmLazyLogger.error(`A total of ${e.length} package(s) failed to obtain the download url.`),e.forEach((e=>{l.OhpmLazyLogger.error(` Failed to obtain the "${e}" package download url`)})))}(x,q),function(e,r){r.size-e.length&&l.OhpmLazyLogger.info(`A total of ${r.size-e.length} package(s) are successfully downloaded.`);e.length&&l.OhpmLazyLogger.error(`A total of ${e.length} package(s) fail to be downloaded.`)}($,q),function(e,r,t){t-e.length&&l.OhpmLazyLogger.info(`A total of ${t-e.length} package(s) are converted successfully.`);e.length&&(l.OhpmLazyLogger.error(`A total of ${e.length} package(s) fail to be converted.`),e.forEach((e=>{l.OhpmLazyLogger.error(`Conversion failed: "${e}"`)})));r.size&&l.OhpmLazyLogger.error(`The ${JSON.stringify(Array.from(r))} group does not exist in the repository. Manually create it.`)}(E,_,z),yield function(r,o){return e(this,void 0,void 0,(function*(){const e=t.default.join(o,c.PACK_DIR);if((yield i.FsUtil.readdir(e)).length<2)return;const n=t.default.join(process.cwd(),r);l.OhpmLazyLogger.info("Packing the .zip file. . ."),yield u.default.zip.compressDir(e,n),l.OhpmLazyLogger.info(`save the .zip file to : "${t.default.normalize(n)}".`)}))}(f,g),v.length&&(yield(0,C.genErrorTxt)(v))}))};