"use strict";var e=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,s)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAllPackagesTarBall=void 0;const n=require("../../../../../../packages/log"),r=t(require("node-fetch")),i=require("../../../../common/getPublicRegistryAgent"),a=require("../index"),o=require("../../../../../../service/validator/customValidateFunc/localDependenciesValidate"),s=t(require("semver")),c=require("../../../../../../concurrent/ConcurrentExecutor");var d;function l(t,r,i,a,o,s){return e(this,void 0,void 0,(function*(){const e=t.slice(0,t.lastIndexOf("@")),c=t.slice(t.lastIndexOf("@")+1);try{yield u(e,c,r,i,a,"")}catch(e){o.push(t);const r=`Failed to obtain the "${t}" package and its dependency download url, ${e.message}`;s.push(r),n.OhpmLazyLogger.error(r)}}))}function u(t,a,c,l,u,g){return e(this,void 0,void 0,(function*(){if(g.includes(`${t}@${a}`)){const e=g.split(";")[1];return void n.OhpmLazyLogger.warn(`The "${t}@${a}" package has a circular dependency on the main dependency "${e}" package. Stop searching for the dependency.`)}const h=(0,o.isLocalDependency)(a);if(h&&!(0,o.isInnerPkgDependency)(a))throw new Error(`the version of the "${t}@${a}" package is invalid.`);if(h)return;const p=yield function(t,a,o,s){return e(this,void 0,void 0,(function*(){const e=`${o}/${t}`;let c;if(s.has(e))c=JSON.parse(s.get(e));else{n.OhpmLazyLogger.info(`fetching metadata ${e}.`);const t=yield(0,r.default)(e,{agent:(0,i.getPublicRegistryAgent)(e)});if(!t.ok)throw new Error(`fetch package metadata failed, ${e}`);c=yield t.json(),s.set(e,JSON.stringify(c))}if(!c.versions)throw new Error(`The metadata of the "${t}@${a}" package is incorrect.`);return c}))}(t,a,c,u);if(!p.versions[a]&&p["dist-tags"][a]){if(!p["dist-tags"][a]||!p.versions[p["dist-tags"][a]])throw new Error(`the version metadata of the "${t}@${a}" package does not exist.`);a=p["dist-tags"][a]}const y=function(e,t){let n=t;"latest"===n&&(n="*");if(s.default.valid(t)&&e.includes(t))return t;return s.default.maxSatisfying(e,n)||s.default.maxSatisfying(e,n,{includePrerelease:!0,loose:!0})}(Object.keys(p.versions),a);if(!y)throw new Error(`the version metadata of the "${t}@${a}" package does not exist.`);const v=p.versions[y],m=`${g};${t}@${a}`;yield f(d.dependencies,v,c,l,u,m),yield f(d.dynamicDependencies,v,c,l,u,m),l.set(`${t}@${y}`,{tarball:v.dist.tarball,integrity:v.dist.integrity})}))}function f(t,n,r,i,a,o){return e(this,void 0,void 0,(function*(){if(n[t]){const e=Object.keys(n[t]);for(const s of e){const e=n[t][s];yield u(s,e,r,i,a,o)}}}))}!function(e){e.dependencies="dependencies",e.dynamicDependencies="dynamicDependencies"}(d||(d={})),exports.getAllPackagesTarBall=function(t,r,i){return e(this,void 0,void 0,(function*(){n.OhpmLazyLogger.info(`Start to get all packages download url from ${r}`);const o=new Map,s=new Map,d=[],u=c.ConcurrentExecutor.creatInstance();for(const n of t)u.addAsyncTask((()=>e(this,void 0,void 0,(function*(){return l(n,r,o,s,d,i)}))));const{maxConcurrent:f,retryInterval:g,retryTimes:h}=a.batchDownloadRegistryLocalData;return yield u.runWithErrorHandle(f,h,g),s.clear(),{getTarBallErrors:d,pkgTarBallMap:o}}))};