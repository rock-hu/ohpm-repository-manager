"use strict";var e=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(n,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadConfig=exports.checkStorageExecute=exports.checkStorageCmd=exports.getSftpList=exports.hasPackageBeenAltered=exports.packageListDisplay=exports.packageDisplay=exports.makePackagePath=exports.packagesMap=exports.getAllPackages=exports.buildFilter=void 0;const o=require("../plugins/storage/SftpOperate"),r=require("../packages/log"),n=require("../service/client/publish/PublishService"),i=require("../common/Constants"),s=require("../utils/FsUtil"),a=t(require("path")),c=require("../service/repo/PageParam"),l=require("../packages/definitions/types"),u=require("../common/init"),p=require("../packages/config/config"),d=require("../service/package/PackageRepository"),f=require("../utils/CommonConstants"),g=require("../utils/PageUtil"),h=require("../service/downloadFailure/DownloadFailureService"),y=require("../utils/RandomUtil"),m=require("./install"),k=require("../packages/config/constants"),v=require("../common/DbAndStoreType"),x=t(require("log4js")),P=require("../packages/config/checker");function S(e,t){const o={};if(t&&(o.handled=l.HandledType.UnProcess),"@all"===e)return o;let r,n,i;return e.startsWith("@")?e.includes("/")?[r,n]=e.split("/"):r=e:n=e,(null==n?void 0:n.includes("@"))&&([n,i]=n.split("@")),r&&n&&(n=`${r}/${n}`),r&&(o.groupName=r.slice(1)),n&&(o.name=n),i&&(o.version=i),o}function $(t,o){return e(this,void 0,void 0,(function*(){let r;return r=t?(yield h.downloadFailureService.getCheckPackage(1,g.MAX_PAGE_SIZE,o)).recordList:yield function(t,o={}){return e(this,void 0,void 0,(function*(){return o.status=f.PackageStatus.Published,(yield d.packageRepository.findByFilter(o,t.getCurrentPage(),t.getPageSize())).recordList}))}(new c.PageParam({currentPage:1,pageSize:g.MAX_PAGE_SIZE}),o),q(r)}))}function q(e){var t;const o=new Map;for(const r of e){const e=C(r);o.has(e)?null===(t=o.get(e))||void 0===t||t.push(r):o.set(e,[r])}return o}function w(e){const{repoName:t,name:o,version:r}=e;if(o.includes("/")){const e=o.split("/")[1];return`/${t}/${o}/${e}-${r}.har`}return`/${t}/${o}/${o}-${r}.har`}function C(e){const{name:t,version:o}=e;return`${t}@${o}`}function _(e){return e.map(C).join(", ")}function A(t,r,i,a){return e(this,void 0,void 0,(function*(){yield o.SftpOperate.get(t,r,a);const e=yield n.publishService.calculatedChecksum(a);return yield s.FsUtil.rm(a),i!==e}))}function E(){return e(this,void 0,void 0,(function*(){const e=yield o.SftpOperate.getPools();return Object.keys(e)}))}function F(t,n){return e(this,void 0,void 0,(function*(){const{failed:e}=n;if((yield b()).store.type!==v.StorageType.Sftp)throw new Error(`command "check_storage" only supports "${v.StorageType.Sftp}"`);yield u.MainInit.particalInit();const s=a.default.join(i.Constants.DATA_DIR,"./temp",y.RandomUtil.generateSecureRandomString(8)),c=S(t,e),l=yield $(e,c),p=yield E();for(const e of p){const t=l.size;let n=0;const i=[],a=[];for(const[,t]of l)try{const r=t[0];if(!r)continue;const c=w(r);if(yield o.SftpOperate.exists(e,c)){n++;const{checksum:t}=r;(yield A(e,c,t,s))&&a.push(r)}else i.push(r)}catch(e){e instanceof Error&&r.OhpmLazyLogger.error(e.message)}if(t){const o=a.length;(0,r.consoleInfo)(`in ${e}, total: ${t}, complete: ${n-o}, not complete: ${o}, not found: ${i.length}.`),i.length>0&&(0,r.consoleInfo)(`the following packages does not exist in ${e}: ${_(i)}.`),a.length>0&&(0,r.consoleInfo)(`the following packages is not complete in ${e}: ${_(a)}.`)}else(0,r.consoleInfo)(`in ${e}, no results match your search criteria.`)}x.default.shutdown((()=>process.exit(0)))}))}function b(){return e(this,void 0,void 0,(function*(){const e=yield(0,m.readFileFromEnv)(k.PathConstants.RUNTIME_PATH),t=yield(0,m.readCongFileFromEnv)();if(!(yield s.FsUtil.exists(e))||0===t.length)throw new Error("please run `ohpm-repo start` before check storage");return yield(0,p.parseAndUpdateGlobalConfig)(t),yield(0,P.checkAndUpdateConfig)(p.config),p.config}))}exports.buildFilter=S,exports.getAllPackages=$,exports.packagesMap=q,exports.makePackagePath=w,exports.packageDisplay=C,exports.packageListDisplay=_,exports.hasPackageBeenAltered=A,exports.getSftpList=E,exports.checkStorageCmd=function(t,o){return e(this,void 0,void 0,(function*(){try{yield F(t,o),x.default.shutdown((()=>process.exit(0)))}catch(e){(0,r.consoleError)(`server fail to check storage: ${e}.`),x.default.shutdown((()=>process.exit(1)))}}))},exports.checkStorageExecute=F,exports.loadConfig=b;